using Content.Shared.Administration;
using Robust.Client.AutoGenerated;
// ADT-Tweak start. Система тегов в АХелп
using Content.Client.UserInterface.Systems.Bwoink;
using System.Text.RegularExpressions;
using Robust.Client.UserInterface;
// ADT-Tweak end
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Utility;

namespace Content.Client.Administration.UI.Bwoink
{
    [GenerateTypedNameReferences]
    public sealed partial class BwoinkPanel : BoxContainer
    {
        // ADT-Tweak start. Система тегов в АХелп
        public int SelectedTypeTagId = 0; // Переменная для хранение выбранного тега
        public int LastTagId { get; private set; } = -1; // Переменная для хранения последнего выбора тега
        // ADT-Tweak end.
        private readonly Action<string> _messageSender;

        public int Unread { get; private set; } = 0;
        public DateTime LastMessage { get; private set; } = DateTime.MinValue;
        private List<string> PeopleTyping { get; set; } = new();
        public event Action<string>? InputTextChanged;

        /* ADT-Tweak. Система тегов в АХелп.
        В конструктор добавлен параметр по умолчанию bool isUserAHelp = false */
        public BwoinkPanel(Action<string> messageSender, bool isUserAHelp = false)
        {
            RobustXamlLoader.Load(this);

            InitializeAHelpPanel(isUserAHelp); // ADT-Tweak start. Система тегов в АХелп

            var msg = new FormattedMessage();
            msg.PushColor(Color.LightGray);
            msg.AddText(Loc.GetString("bwoink-system-messages-being-relayed-to-discord"));
            msg.Pop();
            RelayedToDiscordLabel.SetMessage(msg);

            _messageSender = messageSender;

            OnVisibilityChanged += c =>
            {
                if (c.Visible)
                    Unread = 0;
            };
            SenderLineEdit.OnTextEntered += Input_OnTextEntered;
            SenderLineEdit.OnTextChanged += Input_OnTextChanged;
            UpdateTypingIndicator();
        }

        // ADT-Tweak start. Система тегов в АХелп
        // Функция для проверки на то, какой интерфейс АХелпа открыт(игрока, админа)
        private void InitializeAHelpPanel(bool isAHelp)
        {
            if (isAHelp)
            {
                // Перебор и добавление тегов в список
                for (int i = 1; i <= BwoinkControl.TagCount; i++)
                {
                    TypeTag.AddItem(Loc.GetString($"ahelp-user-type-tag-{i}"));
                }

                // Обработчик выбора тега
                TypeTag.OnItemSelected += type_tag =>
                {
                    SelectedTypeTagId = type_tag.Id;
                    UpdateOptionButtons();
                };
            }
            else
            {
                TypeTag.Visible = false; // Костыль. Скрываем теги в административном интерфейсе
                AHelpUserTagName.Visible = false; // Костыль. Скрываем текст в административном интерфейсе
            }
        }

        // Функция для визуального обновления выбора кнопки тега
        private void UpdateOptionButtons()
        {
            TypeTag.SelectId(SelectedTypeTagId);
        }
        // ADT-Tweak end

        private void Input_OnTextEntered(LineEdit.LineEditEventArgs args)
        {
            if (string.IsNullOrWhiteSpace(args.Text))
                return;

            // ADT-Tweak start. Система тегов в АХелп
            var uiController = IoCManager.Resolve<IUserInterfaceManager>().GetUIController<AHelpUIController>();

            // Добавление [Tag:X] к отправленному сообщению от ИГРОКА, если сообщение из ПОЛЬЗОВАТЕЛЬСКОГО АХелпа
            if (uiController.UIHelper is AdminAHelpUIHandler adminAhelp)
            {
                _messageSender.Invoke(args.Text);
            }
            else
            {
                _messageSender.Invoke($"[Tag:{SelectedTypeTagId}] {args.Text}");
            }
            // ADT-Tweak end.

            SenderLineEdit.Clear();
        }

        private void Input_OnTextChanged(LineEdit.LineEditEventArgs args)
        {
            InputTextChanged?.Invoke(args.Text);
        }

        public void ReceiveLine(SharedBwoinkSystem.BwoinkTextMessage message)
        {
            if (!Visible)
                Unread++;

            /* ADT-Tweak start. Система тегов в АХелп.
            Ищем [Tag:X] с помощью регулярного выражения */
            var tagMatch = Regex.Match(message.Text, @"\[Tag:(\d+)\]");
            if (tagMatch.Success)
            {
                if (int.TryParse(tagMatch.Groups[1].Value, out var tagId) && tagId >= 0 && tagId < BwoinkControl.TagCount)
                {
                    LastTagId = tagId;
                }
            }
            // ADT-Tweak end.

            var formatted = new FormattedMessage(1);
            formatted.AddMarkupOrThrow($"[color=gray]{message.SentAt.ToShortTimeString()}[/color] {message.Text}");
            TextOutput.AddMessage(formatted);
            LastMessage = message.SentAt;
        }

        private void UpdateTypingIndicator()
        {
            var msg = new FormattedMessage();
            msg.PushColor(Color.LightGray);

            var text = PeopleTyping.Count == 0
                ? string.Empty
                : Loc.GetString("bwoink-system-typing-indicator",
                    ("players", string.Join(", ", PeopleTyping)),
                    ("count", PeopleTyping.Count));

            msg.AddText(text);
            msg.Pop();

            TypingIndicator.SetMessage(msg);
        }

        public void UpdatePlayerTyping(string name, bool typing)
        {
            if (typing)
            {
                if (PeopleTyping.Contains(name))
                    return;

                PeopleTyping.Add(name);
                Timer.Spawn(TimeSpan.FromSeconds(10), () =>
                {
                    if (Disposed)
                        return;

                    PeopleTyping.Remove(name);
                    UpdateTypingIndicator();
                });
            }
            else
            {
                PeopleTyping.Remove(name);
            }

            UpdateTypingIndicator();
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose(disposing);

            InputTextChanged = null;
        }
    }
}
