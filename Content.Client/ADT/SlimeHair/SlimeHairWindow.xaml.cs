using Content.Client.Corvax.Sponsors;
using Content.Client.Humanoid;
using Content.Shared.ADT.SlimeHair;
using Content.Shared.Corvax.TTS;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Markings;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using System.Linq;

namespace Content.Client.ADT.SlimeHair;

[GenerateTypedNameReferences]
public sealed partial class SlimeHairWindow : DefaultWindow
{
    public Action<(MarkingCategories Category, int Slot, string Id)>? OnSlotMarkingSelected;
    public Action<(MarkingCategories Category, int Slot, List<Color> Colors)>? OnSlotColorChanged;
    public Action<(MarkingCategories Category, int Slot)>? OnSlotRemoved;
    public Action<MarkingCategories>? OnSlotAdded;

    public Action<string>? OnVoiceChanged;

    private readonly IPrototypeManager _prototypeManager = IoCManager.Resolve<IPrototypeManager>();
    private readonly SponsorsManager _sponsorsManager = IoCManager.Resolve<SponsorsManager>();

    private List<TTSVoicePrototype> _voiceList = new();

    public SlimeHairWindow()
    {
        RobustXamlLoader.Load(this);

        VoiceButton.OnItemSelected += args =>
        {
            VoiceButton.SelectId(args.Id);
            OnVoiceChanged?.Invoke(_voiceList[args.Id].ID);
        };

        _voiceList = _prototypeManager
            .EnumeratePrototypes<TTSVoicePrototype>()
            .Where(o => o.RoundStart)
            .OrderBy(o => Loc.GetString(o.Name))
            .ToList();
    }

    public void UpdateState(SlimeHairUiState state)
    {
        MarkingsContainer.RemoveAllChildren();
        foreach (var item in state.Markings)
        {
            var picker = new SingleMarkingPicker()
            {
                Category = item.Key,
                Margin = new(2, 0),
                MinWidth = 325,
                MaxWidth = 650
            };
            picker.ColorSelectorContainer.Orientation = BoxContainer.LayoutOrientation.Vertical;
            picker.UpdateData(item.Value, state.Species, state.SlotsTotal[item.Key], state.AllowColorChanges);

            picker.OnMarkingSelect += args => OnSlotMarkingSelected?.Invoke((item.Key, args.slot, args.id));
            picker.OnColorChanged += args => OnSlotColorChanged?.Invoke((item.Key, args.slot, args.marking.MarkingColors.ToList()));
            picker.OnSlotRemove += args => OnSlotRemoved?.Invoke((item.Key, args));
            picker.OnSlotAdd += () => OnSlotAdded?.Invoke(item.Key);
            MarkingsContainer.AddChild(picker);
        }

        if (state.TTS != null && state.Bark != null)
        {
            UpdateVoice(state.Sex, state.TTS);
            VoiceContainer.Visible = true;
        }
        else
            VoiceContainer.Visible = false;

        if (state.SlotsTotal.Count <= 0)
            AddChild(new Label { Text = Loc.GetString("magic-mirror-component-activate-user-has-no-hair") });
    }

    private void UpdateVoice(Sex sex, string currentVoice)
    {
        VoiceButton.Clear();

        var firstVoiceChoiceId = 1;
        for (var i = 0; i < _voiceList.Count; i++)
        {
            var voice = _voiceList[i];
            if (!HumanoidCharacterProfile.CanHaveVoice(voice, sex))
                continue;

            var name = Loc.GetString(voice.Name);
            VoiceButton.AddItem(name, i);

            if (firstVoiceChoiceId == 1)
                firstVoiceChoiceId = i;

            if (voice.SponsorOnly &&
                _sponsorsManager.TryGetInfo(out var sponsor) &&
                !sponsor.AllowedMarkings.Contains(voice.ID))
            {
                VoiceButton.SetItemDisabled(VoiceButton.GetIdx(i), true);
            }
        }

        var voiceChoiceId = _voiceList.FindIndex(x => x.ID == currentVoice);
        if (!VoiceButton.TrySelectId(voiceChoiceId) &&
            VoiceButton.TrySelectId(firstVoiceChoiceId))
        {
            OnVoiceChanged?.Invoke(_voiceList[firstVoiceChoiceId].ID);
        }
    }
}
