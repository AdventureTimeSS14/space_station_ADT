using Content.Shared.Administration;
using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;

namespace Content.Client.Administration.UI.Tabs.AdminTab
{
    [GenerateTypedNameReferences]
    [UsedImplicitly]
    public sealed partial class EchoChatPanelWindow : DefaultWindow
    {
        [Dependency] private readonly IClientConsoleHost _consoleHost = default!;

        private int _selectedTypeId = 0;

        public EchoChatPanelWindow()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);

            // Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ‚Ð¸Ð¿Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
            MessageTypeOption.AddItem(Loc.GetString("admin-echo-chat-type-speak"));
            MessageTypeOption.AddItem(Loc.GetString("admin-echo-chat-type-emote"));
            MessageTypeOption.AddItem(Loc.GetString("admin-echo-chat-type-whisper"));
            MessageTypeOption.SelectId(0);

            // ÐŸÐ¾Ð»ÑƒÐ¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð² Ð¿Ð¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð°
            MessageText.Placeholder = new Rope.Leaf(Loc.GetString("admin-echo-chat-placeholder"));

            // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
            PlayerNameLine.OnTextChanged += _ => UpdateSubmitButton();
            MessageText.OnKeyBindUp += _ => UpdateSubmitButton();
            PlayerList.OnSelectionChanged += OnPlayerSelectionChanged;
            SubmitButton.OnPressed += OnSubmitPressed;

            MessageTypeOption.OnItemSelected += args =>
            {
                _selectedTypeId = args.Id;
                Logger.Info($"Ð’Ñ‹Ð±Ñ€Ð°Ð½ Ñ‚Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½): {_selectedTypeId}");
                UpdateSubmitButton();
            };

            UpdateSubmitButton();
        }

        private void UpdateSubmitButton()
        {
            var message = Rope.Collapse(MessageText.TextRope).Trim();
            SubmitButton.Disabled =
                string.IsNullOrWhiteSpace(PlayerNameLine.Text) ||
                string.IsNullOrWhiteSpace(message);

            MessageTypeOption.SelectId(_selectedTypeId);
            MessageTypeOption.UpdateDraw();
        }

        private void OnPlayerSelectionChanged(PlayerInfo? player)
        {
            PlayerNameLine.Text = player?.Username ?? string.Empty;
            UpdateSubmitButton();
        }

        private void OnSubmitPressed(BaseButton.ButtonEventArgs args)
        {
            var playerName = PlayerNameLine.Text;
            var message = Rope.Collapse(MessageText.TextRope).Trim();

            if (string.IsNullOrWhiteSpace(playerName) || string.IsNullOrWhiteSpace(message))
                return;

            var type = _selectedTypeId switch
            {
                0 => "speak",
                1 => "emote",
                2 => "whisper",
                _ => "speak"
            };

            var escapedMessage = CommandParsing.Escape(message);
            _consoleHost.ExecuteCommand($"echo_chat \"{playerName}\" \"{escapedMessage}\" {type}");
        }
    }
}

/*
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   SchrÃ¶dinger's Cat Code   ðŸ¾      â•‘
    â•‘   /\_/\\                           â•‘
    â•‘  ( o.o )  Meow!                    â•‘
    â•‘   > ^ <                            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*/
