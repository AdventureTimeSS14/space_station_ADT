using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using Content.Client.ADT.Discord;

namespace Content.Client.Lobby.UI;

[GenerateTypedNameReferences]
[UsedImplicitly]
public sealed partial class DiscordLincWindow : DefaultWindow
{
    public static bool HasLinkedDiscord { get; private set; }

    [Dependency] private readonly IClipboardManager _clipboard = default!;
    [Dependency] private readonly IPlayerManager _player = default!;
    [Dependency] private readonly DiscordIdManager _discordIdManager = default!;

    private string? _discordId;
    private bool _isLinked = false;

    public DiscordLincWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        // Пытаемся получить Discord ID через DiscordIdManager
        if (_discordIdManager.TryGetDiscordId(out var discordId))
        {
            _discordId = discordId;
            _isLinked = true;
        }

        UpdateStatus();

        CopyButton.OnPressed += _ =>
        {
            var text = GetInstructionText();
            _clipboard.SetText(text);
        };

        LinkButton.OnPressed += _ =>
        {
            _isLinked = true;
            UpdateStatus();
        };
    }

    private void UpdateStatus()
    {
        HasLinkedDiscord = _isLinked;

        if (_isLinked)
        {
            StatusLabel.Text = $"Ваш аккаунт уже привязан к Discord: {_discordId}";
            LinkButton.Visible = false;
        }
        else
        {
            StatusLabel.Text = "Ваш аккаунт НЕ привязан к Discord.";
            LinkButton.Visible = true;
        }

        var message = new FormattedMessage();
        message.AddMarkup(GetInstructionText());
        InstructionLabel.SetMessage(message);
    }

    private string GetInstructionText()
    {
        var uid = _player.LocalSession?.UserId.ToString() ?? "UNKNOWN";
        return $"Введите ваш UID: [color=green]{uid}[/color] в канале Discord:\n" +
               "[color=green]https://discord.com/channels/901772674865455115/1351213738774237184[/color]";
    }
}
