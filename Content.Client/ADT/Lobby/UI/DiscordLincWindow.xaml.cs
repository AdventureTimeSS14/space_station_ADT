// using Content.Shared.ADT.Discord;
using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Network;
using Robust.Shared.Utility;


namespace Content.Client.Lobby.UI
{
    [GenerateTypedNameReferences]
    [UsedImplicitly]
    public sealed partial class DiscordLincWindow : DefaultWindow
    {
        // Публичное статическое свойство для доступа извне
        public static bool HasLinkedDiscord { get; private set; }

        [Dependency] private readonly IClipboardManager _clipboard = default!;
        [Dependency] private readonly IPlayerManager _player = default!;
        [Dependency] private readonly IClientNetManager _net = default!;

        private string? _discordId;
        private bool _isLinked = false;

        public DiscordLincWindow()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);

            // _net.RegisterNetMessage<MsgReceiveDiscordId>(OnDiscordIdReceived);

            // var msg = new MsgRequestDiscordId
            // {
            //     UserId = _player.LocalSession?.UserId ?? default!
            // };
            // _net.ClientSendMessage(msg);

            UpdateStatus();

            CopyButton.OnPressed += _ =>
            {
                var text = GetInstructionText();
                _clipboard.SetText(text);
            };

            LinkButton.OnPressed += _ =>
            {
                _isLinked = true;
                UpdateStatus();
            };
        }

        // private void OnDiscordIdReceived(MsgReceiveDiscordId msg)
        // {
        //     if (!string.IsNullOrEmpty(msg.DiscordId))
        //     {
        //         _discordId = msg.DiscordId;
        //         _isLinked = true;
        //     }
        //     else
        //     {
        //         _discordId = null;
        //         _isLinked = false;
        //     }

        //     UpdateStatus();
        // }

        private void UpdateStatus()
        {
            HasLinkedDiscord = _isLinked; // Обновляем публичное статическое свойство

            if (_isLinked)
            {
                StatusLabel.Text = $"Ваш аккаунт уже привязан к Discord: {_discordId}";
                LinkButton.Visible = false;
            }
            else
            {
                StatusLabel.Text = "Ваш аккаунт НЕ привязан к Discord.";
                LinkButton.Visible = true;
            }

            var message = new FormattedMessage();
            message.AddMarkup(GetInstructionText());
            InstructionLabel.SetMessage(message);
        }

        private string GetInstructionText()
        {
            var uid = _player.LocalSession?.UserId.ToString() ?? "UNKNOWN";
            return $"Введите ваш UID: [color=green]{uid}[/color] в канале Discord:\n" +
                "[color=green]https://discord.com/channels/901772674865455115/1351213738774237184[/color]";
        }
    }
}
