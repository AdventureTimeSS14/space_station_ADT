using Content.Client.Corvax.Sponsors;
using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using Robust.Client.UserInterface;
using Content.Shared.CCVar;
using Robust.Shared.Configuration;

namespace Content.Client.Lobby.UI;

[GenerateTypedNameReferences]
[UsedImplicitly]
public sealed partial class SponsorInfoWindow : DefaultWindow
{
    [Dependency] private readonly SponsorsManager _sponsorsManager = default!;
    [Dependency] private readonly IPlayerManager _player = default!;
    [Dependency] private readonly IUriOpener _uriOpener = default!;
    [Dependency] private readonly IConfigurationManager _cfg = default!;
    public static bool HasSponsor { get; private set; }
    private string _userName = string.Empty;

    public SponsorInfoWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _userName = _player.LocalSession?.Name ?? "Неизвестный игрок";
        HasSponsor = _sponsorsManager.TryGetInfo(out var sponsor) && sponsor != null;

        ButtonSiteBoosty.OnPressed += _ =>
        {
            var url = _cfg.GetCVar(CCVars.InfoLinksWebsite);
            _uriOpener.OpenUri(url);
        };

        UpdateSponsorInfo();
    }

    private void UpdateSponsorInfo()
    {
        List<string> lines;

        if (_sponsorsManager.TryGetInfo(out var sponsor) && sponsor != null)
        {
            lines = new List<string>
            {
                $"[color=yellow]Никнейм:[/color] {_userName}",
                $"[color=yellow]Уровень спонсорства:[/color] {sponsor.Tier ?? 0}",
                $"[color=yellow]Цвет OOC:[/color] {sponsor.OOCColor ?? "не задан"}",
                $"[color=yellow]Приоритетный вход:[/color] {(sponsor.HavePriorityJoin ? "Да" : "Нет")}",
                $"[color=yellow]Дата окончания:[/color] {sponsor.ExpireDate:dd.MM.yyyy}",
                $"[color=yellow]Игнор времени ролей:[/color] {(sponsor.AllowJob ? "Да" : "Нет")}"
            };
        }
        else
        {
            lines = new List<string>
            {
                $"[color=yellow]Никнейм:[/color] {_userName}",
                "[color=yellow]Уровень спонсорства:[/color] —",
                "[color=yellow]Цвет OOC:[/color] —",
                "[color=yellow]Приоритетный вход:[/color] —",
                "[color=yellow]Дата окончания:[/color] —",
                "[color=yellow]Игнор времени ролей:[/color] —"
            };
        }

        var formatted = new FormattedMessage();
        formatted.AddMarkup(string.Join("\n", lines));
        SponsorLabel.SetMessage(formatted);
    }
}
