using System.Linq;
using System.Text.RegularExpressions;
using Content.Client.Message;
using Content.Shared.ADT.Economy;
using Robust.Client.AutoGenerated;
using Content.Client.Stylesheets;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client.ADT.Economy.UI;

[GenerateTypedNameReferences]
public sealed partial class BankUiFragment : BoxContainer
{
    public Action<BankAccountLinkMessage>? OnLinkAttempt;
    public Action<BankTabSwitchMessage>? OnTabSwitch;
    private bool _accountLinkActive;
    private readonly string _lineEditPattern = "[^0-9]";

    public BankUiFragment()
    {
        RobustXamlLoader.Load(this);

        AccountLinkButton.OnPressed += _ =>
        {
            _accountLinkActive = true;
            AccountLinkResultLabel.Visible = false;
            UpdateAccountLinkUi();
        };

        LinkCancelButton.OnPressed += _ =>
        {
            _accountLinkActive = false;
            UpdateAccountLinkUi();
        };

        PinLineEdit.OnTextChanged += _ =>
        {
            ValidateLineEdit(PinLineEdit, 4);
        };

        AccountLineEdit.OnTextChanged += _ =>
        {
            ValidateLineEdit(AccountLineEdit, 6);
        };

        LinkConfirmButton.OnPressed += _ =>
        {
            if (PinLineEdit.Text.Length != 4 || AccountLineEdit.Text.Length != 6)
                return;

            var accountId = int.Parse(AccountLineEdit.Text);
            var pin = int.Parse(PinLineEdit.Text);
            AccountLinkResultLabel.Visible = true;
            _accountLinkActive = false;
            OnLinkAttempt?.Invoke(new BankAccountLinkMessage(accountId, pin));
        };

        AccountTabButton.OnPressed += _ => SwitchTab(BankTab.Account);
        HistoryTabButton.OnPressed += _ => SwitchTab(BankTab.History);
    }

    private void SwitchTab(BankTab tab)
    {
        AccountTab.Visible = tab == BankTab.Account;
        HistoryTab.Visible = tab == BankTab.History;

        AccountTabButton.StyleClasses.Remove("TabButtonActive");
        HistoryTabButton.StyleClasses.Remove("TabButtonActive");

        if (tab == BankTab.Account)
            AccountTabButton.StyleClasses.Add("TabButtonActive");
        else
            HistoryTabButton.StyleClasses.Add("TabButtonActive");

        OnTabSwitch?.Invoke(new BankTabSwitchMessage(tab));
    }

    public void UpdateState(BankCartridgeUiState state)
    {
        var accountLinked = state.AccountId != null;

        RichTextLabelExt.SetMarkup(AccountLinkMessageLabel, state.AccountLinkMessage);
        RichTextLabelExt.SetMarkup(AccountLinkResultLabel, state.AccountLinkResult);

        LinkedAccount.Visible = accountLinked;
        NoLinkedAccountLabel.Visible = !accountLinked;

        if (accountLinked)
        {
            RichTextLabelExt.SetMarkup(LinkedAccountNumberLabel, Loc.GetString("bank-program-ui-account-number-text",
                ("account", state.AccountId!.Value)));
            RichTextLabelExt.SetMarkup(LinkedAccountNameLabel, Loc.GetString("bank-program-ui-account-owner-text",
                ("owner", state.OwnerName)));
            RichTextLabelExt.SetMarkup(LinkedAccountBalanceLabel, Loc.GetString("atm-ui-balance", ("balance", state.Balance)));

            UpdateTransactionHistory(state);
            UpdateAccountLinkUi();
            return;
        }

        RichTextLabelExt.SetMarkup(NoLinkedAccountLabel, Loc.GetString("bank-program-ui-no-account"));
        UpdateAccountLinkUi();
    }

    private void UpdateTransactionHistory(BoundUserInterfaceState state)
    {
        TransactionList.RemoveAllChildren();
        var castState = (BankCartridgeUiState)state;

        if (castState.TransactionHistory.Count == 0)
        {
            NoTransactionsLabel.Visible = true;
            return;
        }

        NoTransactionsLabel.Visible = false;

        var sortedTransactions = castState.TransactionHistory.OrderByDescending(t => t.Timestamp).ToList();

        foreach (var transaction in sortedTransactions)
        {
            var transactionContainer = new PanelContainer
            {
                StyleClasses = { StyleBase.ClassHighDivider },
                HorizontalExpand = true
            };

            var transactionBox = new BoxContainer
            {
                Orientation = LayoutOrientation.Vertical,
                HorizontalExpand = true,
                Margin = new Thickness(8)
            };

            var mainLabel = new Label
            {
                Text = $"{GetTransactionIcon(transaction.Type)} {transaction.Description} {(transaction.Amount >= 0 ? "+" : "")}{transaction.Amount}"
            };

            var detailLabel = new Label
            {
                Text = $"Ð‘Ð°Ð»Ð°Ð½Ñ: {transaction.BalanceAfter} | {transaction.Timestamp:dd\\.hh\\:mm\\:ss}"
            };

            transactionBox.AddChild(mainLabel);
            transactionBox.AddChild(detailLabel);
            transactionContainer.AddChild(transactionBox);
            TransactionList.AddChild(transactionContainer);
        }
    }

    private string GetTransactionIcon(BankTransactionType type)
    {
        return type switch
        {
            BankTransactionType.AtmDeposit => "Ð¢ÐµÑÑ‚",
            BankTransactionType.AtmWithdraw => "Ð¢ÐµÑÑ‚",
            BankTransactionType.Purchase => "Ð¢ÐµÑÑ‚",
            BankTransactionType.Transfer => "Ð¢ÐµÑÑ‚",
            BankTransactionType.Salary => "Ð¢ÐµÑÑ‚",
            BankTransactionType.EftposPayment => "Ð¢ÐµÑÑ‚",
            _ => "ðŸ“Š"
        };
    }

    private void UpdateAccountLinkUi()
    {
        AccountLinkButton.Visible = !_accountLinkActive;
        AccountLink.Visible = _accountLinkActive;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);
        LinkConfirmButton.Disabled = PinLineEdit.Text.Length != 4 || AccountLineEdit.Text.Length != 6;
    }

    private void ValidateLineEdit(LineEdit lineEdit, int length)
    {
        var text = Regex.Replace(lineEdit.Text, _lineEditPattern, string.Empty);

        if (text.Length > length)
        {
            text = text[..length];
        }

        lineEdit.Text = text;
    }
}
