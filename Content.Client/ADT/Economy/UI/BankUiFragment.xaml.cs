using System.Text.RegularExpressions;
using Content.Client.Message;
using Content.Shared.ADT.Economy;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Toolshed.TypeParsers;

namespace Content.Client.ADT.Economy.UI;

[GenerateTypedNameReferences]
public sealed partial class BankUiFragment : BoxContainer
{
    public Action<BankAccountLinkMessage>? OnLinkAttempt;
    public Action<BankTransferMessage>? OnTransferAttempt;

    private bool _accountLinkActive;
    private bool _transferActive;

    private readonly string _lineEditPattern = "[^0-9]";

    public BankUiFragment()
    {
        RobustXamlLoader.Load(this);

        AccountLinkButton.OnPressed += _ =>
        {
            _accountLinkActive = true;
            AccountLinkResultLabel.Visible = false;
            UpdateAccountLinkUi();
        };

        LinkCancelButton.OnPressed += _ =>
        {
            _accountLinkActive = false;
            UpdateAccountLinkUi();
        };

        PinLineEdit.OnTextChanged += _ =>
        {
            ValidateLineEdit(PinLineEdit, 4);
        };

        AccountLineEdit.OnTextChanged += _ =>
        {
            ValidateLineEdit(AccountLineEdit, 6);
        };

        LinkConfirmButton.OnPressed += _ =>
        {
            if (PinLineEdit.Text.Length != 4 || AccountLineEdit.Text.Length != 6)
                return;

            var accountId = int.Parse((string)AccountLineEdit.Text);
            var pin = int.Parse((string)PinLineEdit.Text);
            AccountLinkResultLabel.Visible = true;
            _accountLinkActive = false;
            OnLinkAttempt?.Invoke(new BankAccountLinkMessage(accountId, pin));
        };

        TransferButton.OnPressed += _ =>
        {
            _transferActive = true;
            TransferButton.Visible = false;
            UpdateTransferUi();
        };

        TransferCancelButton.OnPressed += _ =>
        {
            _transferActive = false;
            TransferButton.Visible = true;
            UpdateTransferUi();
        };
        TransferConfirmButton.OnPressed += _ =>
        {
            if (string.IsNullOrWhiteSpace(TargetAccountLineEdit.Text) || string.IsNullOrWhiteSpace(TransferAmountLineEdit.Text) || string.IsNullOrWhiteSpace(TransferPinLineEdit.Text))
                return;

            if (TargetAccountLineEdit.Text.Length != 6 || TransferPinLineEdit.Text.Length != 4)
                return;

            if (!int.TryParse(TargetAccountLineEdit.Text, out var targetAccount) || !int.TryParse(TransferAmountLineEdit.Text, out var amount) || !int.TryParse(TransferPinLineEdit.Text, out var pin))
                return;

            if (amount <= 0)
                return;

            OnTransferAttempt?.Invoke(new BankTransferMessage(targetAccount, pin, amount));

            _transferActive = false;
            UpdateTransferUi();
        };
    }

    public void UpdateState(BankCartridgeUiState state)
    {
        var accountLinked = state.AccountId != null;

        RichTextLabelExt.SetMarkup(AccountLinkMessageLabel, state.AccountLinkMessage);
        RichTextLabelExt.SetMarkup(AccountLinkResultLabel, state.AccountLinkResult);

        if (!string.IsNullOrEmpty(state.TransferResult))
        {
            RichTextLabelExt.SetMarkup(TransferResultLabel, state.TransferResult);
            TransferResultLabel.Visible = true;
        }
        else
        {
            TransferResultLabel.Visible = false;
        }

        LinkedAccount.Visible = accountLinked;
        NoLinkedAccountLabel.Visible = !accountLinked;

        if (accountLinked)
        {
            RichTextLabelExt.SetMarkup(LinkedAccountNumberLabel, Loc.GetString("bank-program-ui-account-number-text",
                ("account", state.AccountId!.Value)));
            RichTextLabelExt.SetMarkup(LinkedAccountNameLabel, Loc.GetString("bank-program-ui-account-owner-text",
                ("owner", state.OwnerName)));
            RichTextLabelExt.SetMarkup(LinkedAccountBalanceLabel, Loc.GetString("atm-ui-balance", ("balance", state.Balance)));

            TransactionHistoryList.RemoveAllChildren();

            if (state.History == null || state.History.Count == 0)
            {
                var emptyLabel = new RichTextLabel();
                RichTextLabelExt.SetMarkup(emptyLabel, "[color=#888888]Нет транзакций[/color]");
                TransactionHistoryList.AddChild(emptyLabel);
            }
            else
            {
                foreach (var transaction in state.History)
                {
                    var label = new RichTextLabel();
                    var amountColor = transaction.Amount > 0 ? "#00ff00" : "#ff0000";
                    var typeText = transaction.Amount > 0 ? "+" : "";
                    RichTextLabelExt.SetMarkup(label, $"[color=#888888]{transaction.InitiatorName}[/color] [color={amountColor}]{typeText}{transaction.Amount}$[/color] - {transaction.Type} [color=#888888]({transaction.Timestamp.ToString(@"hh\:mm\:ss")})[/color]");
                    TransactionHistoryList.AddChild(label);
                }
            }

            UpdateAccountLinkUi();
            UpdateTransferUi();
            return;
        }

        RichTextLabelExt.SetMarkup(NoLinkedAccountLabel, Loc.GetString("bank-program-ui-no-account"));
        UpdateAccountLinkUi();
    }

    private void UpdateAccountLinkUi()
    {
        AccountLinkButton.Visible = !_accountLinkActive;
        AccountLink.Visible = _accountLinkActive;
    }

    private void UpdateTransferUi()
    {
        TransferButton.Visible = !_transferActive;
        TransferForm.Visible = _transferActive;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);
        LinkConfirmButton.Disabled = PinLineEdit.Text.Length != 4 || AccountLineEdit.Text.Length != 6;
    }

    private void ValidateLineEdit(LineEdit lineEdit, int length)
    {
        var text = Regex.Replace(lineEdit.Text, _lineEditPattern, string.Empty);

        if (text.Length > length)
        {
            text = text[..length];
        }

        lineEdit.Text = text;
    }
}
