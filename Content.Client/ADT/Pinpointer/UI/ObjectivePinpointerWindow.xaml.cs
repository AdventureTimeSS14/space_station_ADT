using System.Linq;
using System.Numerics;
using Content.Shared.ADT.Pinpointer;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.GameObjects;
using Robust.Shared.Localization;

namespace Content.Client.ADT.Pinpointer.UI;

[GenerateTypedNameReferences]
public sealed partial class ObjectivePinpointerWindow : DefaultWindow
{
    public event Action<NetEntity>? OnTargetSelected;

    public ObjectivePinpointerWindow()
    {
        RobustXamlLoader.Load(this);
        Title = Loc.GetString("objective-pinpointer-window-title");
    }

    public void UpdateTargets(List<ObjectivePinpointerTarget> targets)
    {
        TargetList.Children.Clear();

        if (targets.Count == 0)
        {
            var label = new Label
            {
                Text = Loc.GetString("objective-pinpointer-no-targets"),
                HorizontalAlignment = HAlignment.Center
            };
            TargetList.AddChild(label);
            return;
        }

        var stealTargets = targets.Where(t => t.Type == ObjectivePinpointerTargetType.Steal).ToList();
        var killTargets = targets.Where(t => t.Type == ObjectivePinpointerTargetType.Kill).ToList();
        var protectTargets = targets.Where(t => t.Type == ObjectivePinpointerTargetType.Protect).ToList();

        var hasAddedSection = false;

        if (stealTargets.Count > 0)
        {
            var header = new Label
            {
                Text = Loc.GetString("objective-pinpointer-steal-header"),
                StyleClasses = { "LabelHeading" }
            };
            TargetList.AddChild(header);

            foreach (var target in stealTargets)
            {
                AddTargetButton(target);
            }
            hasAddedSection = true;
        }

        if (killTargets.Count > 0)
        {
            if (hasAddedSection)
            {
                TargetList.AddChild(new BoxContainer { MinSize = new Vector2(0, 10) });
            }

            var header = new Label
            {
                Text = Loc.GetString("objective-pinpointer-kill-header"),
                StyleClasses = { "LabelHeading" }
            };
            TargetList.AddChild(header);

            foreach (var target in killTargets)
            {
                AddTargetButton(target);
            }
            hasAddedSection = true;
        }

        if (protectTargets.Count > 0)
        {
            if (hasAddedSection)
            {
                TargetList.AddChild(new BoxContainer { MinSize = new Vector2(0, 10) });
            }

            var header = new Label
            {
                Text = Loc.GetString("objective-pinpointer-protect-header"),
                StyleClasses = { "LabelHeading" }
            };
            TargetList.AddChild(header);

            foreach (var target in protectTargets)
            {
                AddTargetButton(target);
            }
        }
    }

    private void AddTargetButton(ObjectivePinpointerTarget target)
    {
        var button = new Button
        {
            Text = target.DisplayName,
            HorizontalExpand = true
        };

        button.OnPressed += _ =>
        {
            OnTargetSelected?.Invoke(target.Entity);
        };

        TargetList.AddChild(button);
    }
}