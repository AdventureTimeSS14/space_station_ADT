using System.Linq;
using Content.Client.Corvax.Sponsors;
using Content.Client.Corvax.TTS;
using Content.Client.Stylesheets;
using Content.Shared.Corvax.TTS;
using Content.Shared.Humanoid;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.ADT.TTS;

[GenerateTypedNameReferences]
public sealed partial class TTSVoiceSelectionTab : Control
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly SponsorsManager _sponsorsManager = default!;
    private readonly TTSSystem _ttsSystem;
    
    private List<TTSVoicePrototype> _allVoices = new();
    private List<TTSVoicePrototype> _filteredVoices = new();
    private Dictionary<string, List<TTSVoicePrototype>> _voicesByCategory = new();
    private string? _selectedCategory = null;
    private string _currentVoiceId = "";
    private Sex _profileSex = Sex.Unsexed;

    public event Action<string>? OnVoiceSelected;

    public TTSVoiceSelectionTab()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        
        _ttsSystem = IoCManager.Resolve<IEntityManager>().System<TTSSystem>();

        SearchEdit.OnTextChanged += OnSearchTextChanged;
        
        LoadVoices();
    }

    public void SetProfileData(string voiceId, Sex sex)
    {
        _currentVoiceId = voiceId;
        _profileSex = sex;
        
        FilterVoices();
        UpdateVoiceButtons();
    }

    private void LoadVoices()
    {
        _allVoices = _prototypeManager
            .EnumeratePrototypes<TTSVoicePrototype>()
            .Where(v => v.RoundStart)
            .OrderBy(v => Loc.GetString(v.Name))
            .ToList();

        // Группируем голоса по категориям
        _voicesByCategory = _allVoices
            .GroupBy(v => v.Category)
            .ToDictionary(g => g.Key, g => g.ToList());

        BuildCategoryButtons();
        FilterVoices();
    }

    private void BuildCategoryButtons()
    {
        CategoriesContainer.RemoveAllChildren();

        // Кнопка "Все голоса"
        var allButton = new Button
        {
            Text = Loc.GetString("humanoid-profile-editor-tts-all-voices"),
            ToggleMode = true,
            StyleClasses = { StyleBase.ButtonOpenRight },
            HorizontalExpand = true,
            HorizontalAlignment = HAlignment.Left,
            MinWidth = 180,
            MaxWidth = 180,
        };
        allButton.OnPressed += _ => SelectCategory(null);
        CategoriesContainer.AddChild(allButton);

        // Кнопки категорий
        foreach (var category in _voicesByCategory.Keys.OrderBy(c => c))
        {
            // Пытаемся получить локализованное название категории
            var localizedCategory = Loc.TryGetString($"humanoid-profile-editor-tts-category-{category.ToLower()}", out var localized) 
                ? localized 
                : category;

            var button = new Button
            {
                Text = localizedCategory,
                ToggleMode = true,
                StyleClasses = { StyleBase.ButtonOpenRight },
                HorizontalExpand = true,
                HorizontalAlignment = HAlignment.Left,
                MinWidth = 180,
                MaxWidth = 180,
            };
            button.OnPressed += _ => SelectCategory(category);
            CategoriesContainer.AddChild(button);
        }
    }

    private void SelectCategory(string? category)
    {
        _selectedCategory = category;

        // Получаем локализованное название для отображения
        var displayName = category == null 
            ? Loc.GetString("humanoid-profile-editor-tts-all-voices")
            : (Loc.TryGetString($"humanoid-profile-editor-tts-category-{category.ToLower()}", out var localized) ? localized : category);

        // Обновляем состояние кнопок категорий
        var buttons = CategoriesContainer.Children.OfType<Button>().ToList();
        foreach (var button in buttons)
        {
            if (category == null && button.Text == Loc.GetString("humanoid-profile-editor-tts-all-voices"))
                button.Pressed = true;
            else
            {
                // Сравниваем с локализованным названием
                var btnCategory = _voicesByCategory.Keys.FirstOrDefault(c => 
                    (Loc.TryGetString($"humanoid-profile-editor-tts-category-{c.ToLower()}", out var loc) ? loc : c) == button.Text);
                button.Pressed = btnCategory == category;
            }
        }

        SelectedCategoryLabel.Text = displayName;
        FilterVoices();
    }

    private void OnSearchTextChanged(LineEdit.LineEditEventArgs args)
    {
        FilterVoices();
    }

    private void FilterVoices()
    {
        var searchText = SearchEdit.Text.ToLower();
        IEnumerable<TTSVoicePrototype> voices;

        if (_selectedCategory != null)
        {
            voices = _voicesByCategory.GetValueOrDefault(_selectedCategory, new List<TTSVoicePrototype>());
        }
        else
        {
            voices = _allVoices;
        }

        // Фильтруем по полу
        voices = voices.Where(v => v.Sex == _profileSex || v.Sex == Sex.Unsexed);

        // Фильтруем по поисковому запросу
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            voices = voices.Where(v =>
                Loc.GetString(v.Name).ToLower().Contains(searchText) ||
                v.ID.ToLower().Contains(searchText) ||
                (!string.IsNullOrEmpty(v.Description) && Loc.GetString(v.Description).ToLower().Contains(searchText)));
        }

        _filteredVoices = voices.ToList();
        
        ResultsLabel.Text = Loc.GetString("humanoid-profile-editor-tts-found", ("count", _filteredVoices.Count));
        
        BuildVoiceButtons();
    }

    private void BuildVoiceButtons()
    {
        VoicesGrid.RemoveAllChildren();

        foreach (var voice in _filteredVoices)
        {
            var isSponsored = voice.SponsorOnly;
            var hasAccess = !isSponsored || 
                (_sponsorsManager.TryGetInfo(out var sponsor) && sponsor.AllowedMarkings.Contains(voice.ID));

            var button = new Button
            {
                Text = Loc.GetString(voice.Name),
                ToggleMode = true,
                Pressed = voice.ID == _currentVoiceId,
                Disabled = !hasAccess,
                HorizontalExpand = true,
                Margin = new Thickness(2),
            };

            if (isSponsored)
            {
                button.Text += " ⭐";
            }

            button.OnPressed += _ => OnVoiceButtonPressed(voice.ID);
            VoicesGrid.AddChild(button);
        }
    }

    private void OnVoiceButtonPressed(string voiceId)
    {
        _currentVoiceId = voiceId;
        OnVoiceSelected?.Invoke(voiceId);
        UpdateVoiceButtons();
        
        // Проигрываем превью
        _ttsSystem.RequestPreviewTTS(voiceId);
    }

    private void UpdateVoiceButtons()
    {
        foreach (var button in VoicesGrid.Children.OfType<Button>())
        {
            var voiceName = button.Text?.Replace(" ⭐", "") ?? "";
            var voice = _filteredVoices.FirstOrDefault(v => Loc.GetString(v.Name) == voiceName);
            if (voice != null)
            {
                button.Pressed = voice.ID == _currentVoiceId;
            }
        }
    }
}
