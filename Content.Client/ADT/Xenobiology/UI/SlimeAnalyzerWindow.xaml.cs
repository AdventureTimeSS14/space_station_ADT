using Content.Client.UserInterface.Controls;
using Content.Shared.ADT.Xenobiology.Components;
using Content.Shared.ADT.Xenobiology.UI;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;

namespace Content.Client.ADT.Xenobiology.UI;

[GenerateTypedNameReferences]
public sealed partial class SlimeAnalyzerWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;

    public SlimeAnalyzerWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void Populate(SlimeAnalyzerScannedUserMessage msg)
    {
        var target = _entityManager.GetEntity(msg.TargetEntity);
        if (!_entityManager.HasComponent<MobGrowthComponent>(target))
        {
            NoSlimeDataText.Visible = true;
            SlimeDataContainer.Visible = false;
            return;
        }

        NoSlimeDataText.Visible = false;
        SlimeDataContainer.Visible = true;

        // Basic info
        SlimeSpriteView.SetEntity(target);
        var slimeTypeMessage = new FormattedMessage();
        slimeTypeMessage.AddText(Loc.GetString($"slime-mutation-type-{msg.SlimeType.ToString().ToLower()}"));
        SlimeTypeLabel.SetMessage(slimeTypeMessage);
        var stage = Loc.GetString($"slime-analyzer-stage-{msg.GrowthStage.ToString().ToLower()}");
        SlimeStageLabel.Text = Loc.GetString("slime-analyzer-stage", ("stage", stage));

        // Status
        HungerBar.Value = msg.Hunger / msg.MaxHunger;
        HungerText.Text = $"{msg.Hunger:F1}/{msg.MaxHunger:F1}";
        MutationChanceLabel.Text = $"{msg.MutationChance * 100:F1}%";
        SpecialChanceLabel.Text = $"{msg.SpecialMutationChance * 100:F1}%";

        // Mutations
        MutationsList.RemoveAllChildren();
        if (msg.PotentialMutations != null)
        {
            foreach (var breed in msg.PotentialMutations)
            {
                MutationsList.AddChild(new BoxContainer
                {
                    Orientation = BoxContainer.LayoutOrientation.Horizontal,
                    Children =
                    {
                        new Label { Text = "Â· ", Margin = new Thickness(5, 0, 0, 0) },
                        new Label { Text = Loc.GetString($"slime-mutation-type-{breed.ToString().ToLower()}"), HorizontalExpand = true }
                    }
                });
            }
        }
    }
}
