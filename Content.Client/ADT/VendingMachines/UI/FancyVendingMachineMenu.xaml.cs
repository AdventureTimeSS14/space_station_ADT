using System.Linq;
using System.Numerics;
using Content.Shared.VendingMachines;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using FancyWindow = Content.Client.UserInterface.Controls.FancyWindow;
using Robust.Client.UserInterface;
using Content.Client.UserInterface.Controls;
using Content.Shared.IdentityManagement;
using Robust.Client.Graphics;
using System.Text;

namespace Content.Client.ADT.VendingMachines.UI;

[GenerateTypedNameReferences]
public sealed partial class FancyVendingMachineMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;

    private readonly Dictionary<EntProtoId, EntityUid> _dummies = [];
    private readonly List<FancyVendingMachineData> _cachedItems = [];

    public event Action<VendingMachineInventoryEntry>? OnItemSelected;
    public Action? OnWithdraw;

    private double _priceMultiplier = 1;

    public Color ButtonBorderColor = Color.FromHex("#4972A1");
    public Color ButtonBaseColor = Color.FromHex("#141F2F");
    public Color ButtonHoveredColor = Color.FromHex("#4972A1");
    public Color ButtonDisabledColor = Color.FromHex("#3f3f3fff");

    public FancyVendingMachineMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        VendingContents.Columns = 6;

        SearchBar.OnTextChanged += _ => PopulateList();
        WithdrawButton.OnPressed += _ => OnWithdraw?.Invoke();
    }

    public override void Close()
    {
        base.Close();

        // Delete any dummy items we spawned
        foreach (var entity in _dummies.Values)
        {
            _entityManager.QueueDeleteEntity(entity);
        }
        _dummies.Clear();
    }

    private bool DataFilterCondition(string filter, FancyVendingMachineData data)
    {
        if (string.IsNullOrEmpty(filter))
            return true;

        return data.Name.Contains(filter, StringComparison.CurrentCultureIgnoreCase);
    }

    /// <summary>
    /// Populates the list of available items on the vending machine interface
    /// and sets icons based on their prototypes
    /// </summary>
    public void Populate(EntityUid entityUid, List<VendingMachineInventoryEntry> inventory, double priceMultiplier, int credits)
    {
        _cachedItems.Clear();
        _priceMultiplier = _entityManager.GetComponentOrNull<VendingMachineComponent>(entityUid)?.AllForFree ?? true ? 0 : priceMultiplier;

        if (_entityManager.TryGetComponent<VendingMachineComponent>(entityUid, out var comp))
        {
            ButtonBaseColor = comp.UiButtonBaseColor;
            ButtonBorderColor = comp.UiButtonBorderColor;
            ButtonHoveredColor = comp.UiButtonHoveredColor;
            ButtonDisabledColor = comp.UiButtonDisabledColor;
        }

        CreditsLabel.Text = Loc.GetString("vending-ui-credits-amount", ("credits", credits));
        WithdrawButton.Disabled = credits == 0;

        if (inventory.Count == 0 && VendingContents.Visible)
        {
            SearchBar.Visible = false;
            VendingContents.Visible = false;

            var outOfStockLabel = new Label()
            {
                Text = Loc.GetString("vending-machine-component-try-eject-out-of-stock"),
                Margin = new Thickness(4, 4),
                HorizontalExpand = true,
                VerticalAlignment = VAlignment.Stretch,
                HorizontalAlignment = HAlignment.Center
            };

            MainContainer.AddChild(outOfStockLabel);

            return;
        }

        for (var i = 0; i < inventory.Count; i++)
        {
            var entry = inventory[i];

            if (!_dummies.TryGetValue(entry.ID, out var dummy))
            {
                dummy = _entityManager.Spawn(entry.ID);
                _dummies.Add(entry.ID, dummy);
            }

            StringBuilder sb = new(Identity.Name(dummy, _entityManager));
            sb[0] = char.ToUpper(sb[0]);

            _cachedItems.Add(new FancyVendingMachineData(sb.ToString(), entry));
        }

        PopulateList();
    }

    private void PopulateList()
    {
        VendingContents.RemoveAllChildren();

        foreach (var item in _cachedItems.Where(d => DataFilterCondition(SearchBar.Text, d)))
        {
            var price = (int)(item.Entry.Price * _priceMultiplier);
            var listItem = new FancyVendingMachineItem(item.Entry.ID, item.Name, (int)item.Entry.Amount, price);
            listItem.SetColoring(ButtonBaseColor, ButtonBorderColor, ButtonHoveredColor, ButtonDisabledColor);

            listItem.BuyPressed += () => OnItemSelected?.Invoke(item.Entry);

            VendingContents.AddChild(listItem);
        }
    }

    private record struct FancyVendingMachineData(string Name, VendingMachineInventoryEntry Entry);
}
