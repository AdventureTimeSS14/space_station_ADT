using System.Numerics;
using Content.Client.Humanoid;
using Content.Client.Message;
using Content.Client.UserInterface.Controls;
using Content.Shared.ADT.CharecterFlavor;
using Content.Shared.Humanoid;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.ADT.CharecterFlavor;

[GenerateTypedNameReferences]
public sealed partial class CharacterFlavorWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IPrototypeManager _proto = default!;
    [Dependency] private readonly IClyde _clyde = default!;

    public CharacterFlavorWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        HeadshotLoadingLabel.SetMarkup(Loc.GetString("headshot-loading"));
    }

    public void SetEntity(EntityUid uid)
    {
        if (!_entityManager.TryGetComponent<CharacterFlavorComponent>(uid, out var flavor))
            return;

        if (!_entityManager.TryGetComponent<MetaDataComponent>(uid, out var metaData))
            return;

        if (_entityManager.TryGetComponent<HumanoidAppearanceComponent>(uid, out var humanoid)
        && _proto.Index(humanoid.Species).ShortDesc != string.Empty)
        {
            CustomSpeciesLabel.Text = Loc.GetString(_proto.Index(humanoid.Species).ShortDesc);
            CustomSpeciesTitle.Text = Loc.GetString("flavor-interface-custom-species");
        }

        if (flavor.HeadshotUrl != string.Empty)
        {
            HeadshotImage.TexturePath = "/Textures/ADT/Interface/headshot-loading.png";
            HeadshotLoadingLabel.Visible = true;
        }
        else
        {
            HeadshotContainer.Visible = false;
        }

        Title = metaData.EntityName;
        FlavorTextLabel.SetMarkup(flavor.FlavorText);
        OOCNotesLabel.SetMarkup(flavor.OOCNotes);
    }

    public void SetHeadshot(byte[] image)
    {
        var headshot = LoadTextureFromBytes(image);

        if (headshot != null)
        {
            HeadshotImage.Texture = headshot;
            HeadshotImage.ModulateSelfOverride = null;
            HeadshotLoadingLabel.Visible = false;
            HeadshotContainer.Visible = true;
        }
        else
            HeadshotContainer.Visible = false;
    }

    private Texture? LoadTextureFromBytes(byte[] imageBytes)
    {
        try
        {
            using var memoryStream = new System.IO.MemoryStream(imageBytes);
            using var image = SixLabors.ImageSharp.Image.Load<SixLabors.ImageSharp.PixelFormats.Rgba32>(memoryStream);
            return _clyde.LoadTextureFromImage(image);
        }
        catch
        {
            return null;
        }
    }
}
