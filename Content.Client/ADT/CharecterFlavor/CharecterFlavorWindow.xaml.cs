using System.Numerics;
using Content.Client.Humanoid;
using Content.Client.UserInterface.Controls;
using Content.Shared.ADT.CharecterFlavor;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.ADT.CharecterFlavor;

[GenerateTypedNameReferences]
public sealed partial class CharecterFlavorWindow : FancyWindow
{
    private readonly IEntityManager _entityManager;
    private readonly SpriteSystem spriteSystem = default!;
    private readonly IClyde _clyde = default!;
    private EntityUid _charecter;
    
    public CharecterFlavorWindow()
    {
        RobustXamlLoader.Load(this);
        _entityManager = IoCManager.Resolve<IEntityManager>();
        _clyde = IoCManager.Resolve<IClyde>();
        spriteSystem = _entityManager.System<SpriteSystem>();
    }

    public void SetEntity(EntityUid uid)
    {
        CharecterView.SetEntity(uid);
        _charecter = uid;

        if (!_entityManager.TryGetComponent<CharecterFlavorComponent>(_charecter, out var flavor))
            return;
        if (!_entityManager.TryGetComponent<MetaDataComponent>(uid, out var metaData))
            return;

        Texture? headshot = null;

        if (flavor.HeadshotBytes != null && flavor.HeadshotBytes.Length > 0)
        {
            headshot = LoadTextureFromBytes(flavor.HeadshotBytes);
            HeadshotImage.Texture = headshot;
        }
        else
        {
            HeadshotContainer.SetSize = new Vector2(0, 0);
            HeadshotLable.Text = "";
        }
        Title = metaData.EntityName;
        FlavorTextLabel.Text = flavor.FlavorText;
        OOCNotesLabel.Text = flavor.OOCNotes;
    }
    private Texture? LoadTextureFromBytes(byte[] imageBytes)
    {
        try
        {
            using var memoryStream = new System.IO.MemoryStream(imageBytes);
            using var image = SixLabors.ImageSharp.Image.Load<SixLabors.ImageSharp.PixelFormats.Rgba32>(memoryStream);
            return _clyde.LoadTextureFromImage(image);
        }
        catch
        {
            return null;
        }
    }
}