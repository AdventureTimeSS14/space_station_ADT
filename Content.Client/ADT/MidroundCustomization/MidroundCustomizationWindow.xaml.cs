using Content.Client.ADT.Bark;
using Content.Client.ADT.SpeechBarks;
using Content.Client.Corvax.Sponsors;
using Content.Client.Corvax.TTS;
using Content.Client.Humanoid;
using Content.Client.UserInterface.Controls;
using Content.Shared.ADT.MidroundCustomization;
using Content.Shared.ADT.SpeechBarks;
using Content.Shared.Corvax.TTS;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Markings;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using System.Linq;
using System.Numerics;

namespace Content.Client.ADT.MidroundCustomization;

[GenerateTypedNameReferences]
public sealed partial class MidroundCustomizationWindow : DefaultWindow
{
    public Action<(MarkingCategories Category, int Slot, string Id)>? OnSlotMarkingSelected;
    public Action<(MarkingCategories Category, int Slot, List<Color> Colors)>? OnSlotColorChanged;
    public Action<(MarkingCategories Category, int Slot)>? OnSlotRemoved;
    public Action<MarkingCategories>? OnSlotAdded;

    public Action<string>? OnVoiceChanged;
    public Action<string>? OnBarkProtoChanged;
    public Action<float>? OnBarkPitchChanged;
    public Action<float>? OnBarkMinVarChanged;
    public Action<float>? OnBarkMaxVarChanged;

    private SpeechBarksSystem _barkSystem;

    private TTSSystem _ttsSystem;

    private readonly IPrototypeManager _prototypeManager = IoCManager.Resolve<IPrototypeManager>();
    private readonly SponsorsManager _sponsorsManager = IoCManager.Resolve<SponsorsManager>();

    [Dependency] private readonly IEntityManager _entityManager = default!;

    private List<TTSVoicePrototype> _voiceList = new();

    private FancyWindow? _barkWindow;
    private string _currentBarkProto = "";
    private float _currentBarkPitch = 1f;
    private float _currentBarkMinVar = 0.1f;
    private float _currentBarkMaxVar = 0.5f;

    private string _currentVoice = "";

    public MidroundCustomizationWindow()
    {
        IoCManager.InjectDependencies(this);

        _barkSystem = _entityManager.System<SpeechBarksSystem>();
        _ttsSystem = _entityManager.System<TTSSystem>();

        RobustXamlLoader.Load(this);

        VoiceButton.OnItemSelected += args =>
        {
            VoiceButton.SelectId(args.Id);
            _currentVoice = _voiceList[args.Id].ID;
            OnVoiceChanged?.Invoke(_currentVoice);
        };

        VoicePlayButton.OnPressed += _ => PlayPreviewTTS();

        BarkProtoButton.OnPressed += _ => OpenBarkWindow();
        BarkPlayButton.OnPressed += _ => PlayPreviewBark();

        _voiceList = _prototypeManager
            .EnumeratePrototypes<TTSVoicePrototype>()
            .Where(o => o.RoundStart)
            .OrderBy(o => Loc.GetString(o.Name))
            .ToList();
    }

    private void OpenBarkWindow()
    {
        if (_barkWindow != null)
        {
            _barkWindow.Close();
            _barkWindow = null;
        }

        var barkTab = new BarkTab();
        barkTab.SetSelectedBark(_currentBarkProto, _currentBarkPitch, _currentBarkMinVar, _currentBarkMaxVar);

        barkTab.OnBarkSelected += id =>
        {
            OnBarkProtoChanged?.Invoke(id);
            UpdateBarkButtonText(id);
        };
        barkTab.OnPitchChanged += pitch =>
        {
            OnBarkPitchChanged?.Invoke(pitch);
        };
        barkTab.OnMinVarChanged += minVar =>
        {
            OnBarkMinVarChanged?.Invoke(minVar);
        };
        barkTab.OnMaxVarChanged += maxVar =>
        {
            OnBarkMaxVarChanged?.Invoke(maxVar);
        };

        _barkWindow = new FancyWindow
        {
            Title = Loc.GetString("humanoid-profile-editor-bark-window-title"),
            MinSize = new Vector2(750, 600),
        };
        _barkWindow.ContentsContainer.AddChild(barkTab);
        _barkWindow.OnClose += () =>
        {
            _barkWindow = null;
        };
        _barkWindow.OpenCentered();
    }

    private void UpdateBarkButtonText(string proto)
    {
        if (!_prototypeManager.TryIndex<BarkPrototype>(proto, out var bark))
            return;

        BarkProtoButton.Text = Loc.GetString(bark.Name);
    }

    private void PlayPreviewBark()
    {
        _barkSystem.PlayDataPreview(_currentBarkProto, _currentBarkPitch, _currentBarkMinVar, _currentBarkMaxVar);
    }

    private void PlayPreviewTTS()
    {
        _ttsSystem.RequestPreviewTTS(_currentVoice);
    }

    public void UpdateState(MidroundCustomizationUiState state)
    {
        MarkingsContainer.RemoveAllChildren();
        foreach (var item in state.Markings)
        {
            var picker = new SingleMarkingPicker()
            {
                Category = item.Key,
                Margin = new(2, 0),
                MinWidth = 325,
                MaxWidth = 650
            };
            picker.ColorSelectorContainer.Orientation = BoxContainer.LayoutOrientation.Vertical;
            picker.UpdateData(item.Value, state.Species, state.SlotsTotal[item.Key], state.AllowColorChanges);

            picker.OnMarkingSelect += args =>
            {
                OnSlotMarkingSelected?.Invoke((item.Key, args.slot, args.id));
            };
            picker.OnColorChanged += args =>
            {
                OnSlotColorChanged?.Invoke((item.Key, args.slot, args.marking.MarkingColors.ToList()));
            };
            picker.OnSlotRemove += args =>
            {
                OnSlotRemoved?.Invoke((item.Key, args));
            };
            picker.OnSlotAdd += () =>
            {
                OnSlotAdded?.Invoke(item.Key);
            };
            MarkingsContainer.AddChild(picker);
        }

        if (state.TTS != null)
        {
            _currentVoice = state.TTS;
            UpdateVoice(state.Sex, state.Species, state.TTS);
            VoiceContainer.Visible = true;
        }
        else
            VoiceContainer.Visible = false;

        _currentBarkProto = state.BarkProto;
        _currentBarkPitch = state.BarkPitch;
        _currentBarkMinVar = state.BarkMinVar;
        _currentBarkMaxVar = state.BarkMaxVar;
        UpdateBarkButtonText(state.BarkProto);

        if (state.SlotsTotal.Count <= 0)
            AddChild(new Label { Text = Loc.GetString("magic-mirror-component-activate-user-has-no-hair") });
    }

    private void UpdateVoice(Sex sex, ProtoId<SpeciesPrototype> species, string currentVoice)
    {
        VoiceButton.Clear();

        var firstVoiceChoiceId = 1;
        for (var i = 0; i < _voiceList.Count; i++)
        {
            var voice = _voiceList[i];
            if (!HumanoidCharacterProfile.CanHaveVoice(voice, sex, species))
                continue;

            var name = Loc.GetString(voice.Name);
            VoiceButton.AddItem(name, i);

            if (firstVoiceChoiceId == 1)
                firstVoiceChoiceId = i;

            if (voice.SponsorOnly &&
                _sponsorsManager.TryGetInfo(out var sponsor) &&
                !sponsor.AllowedMarkings.Contains(voice.ID))
            {
                VoiceButton.SetItemDisabled(VoiceButton.GetIdx(i), true);
            }
        }

        var voiceChoiceId = _voiceList.FindIndex(x => x.ID == currentVoice);
        if (!VoiceButton.TrySelectId(voiceChoiceId) &&
            VoiceButton.TrySelectId(firstVoiceChoiceId))
        {
            OnVoiceChanged?.Invoke(_voiceList[firstVoiceChoiceId].ID);
            _currentVoice = _voiceList[firstVoiceChoiceId].ID;
        }
    }
}
