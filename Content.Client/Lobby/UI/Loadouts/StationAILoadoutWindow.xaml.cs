using System.Linq;
using System.Numerics;
using Content.Client.Silicons.Laws.Ui;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared.Dataset;
using Content.Shared.Preferences;
using Content.Shared.Preferences.Loadouts;
using Content.Shared.Random.Helpers;
using Content.Shared.Roles;
using Content.Shared.Silicons.Laws;
using Content.Shared.Silicons.StationAi;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Player;
using Robust.Shared.Prototypes;
using Robust.Shared.Random;

namespace Content.Client.Lobby.UI.Loadouts;

[GenerateTypedNameReferences]
public sealed partial class StationAILoadoutWindow : BaseLoadoutWindow, ILoadoutOverride
{
    public Action<HumanoidCharacterProfile?>? OnValueChanged { get; set; }

    public HumanoidCharacterProfile? Profile { get; set; }

    private SiliconLawsetPrototype? _lawset;

    public StationAILoadoutWindow()
    {
        RobustXamlLoader.Load(this);
    }

    public void Refresh(IPrototypeManager protoMan, ref HumanoidCharacterProfile? profile)
    {
        Profile = profile;
        PopulateSkins(protoMan);
        PopulateLaws(protoMan);
    }

    private void PopulateSkins(IPrototypeManager protoMan)
    {
        SkinList.DisposeAllChildren();
        var list = protoMan.EnumeratePrototypes<StationAIScreenPrototype>()
                            .Where(x => x.Roundstart)
                            .OrderBy(x => x.Priority).ThenByDescending(x => x.ID)
                            .ToList();

        foreach (var item in list)
        {
            var button = new Button()
            {
                StyleClasses = { StyleNano.ButtonSquare },
                Margin = new(4),
                SetSize = new(96, 96),
                ToggleMode = true,
                MuteSounds = true,
                Pressed = Profile?.SAIData.Screen == item.ID
            };
            button.OnPressed += args =>
            {
                Profile = Profile?.WithAIScreen(item.ID);

                UserInterfaceManager.ClickSound();  // To avoid click spamming
                PopulateSkins(protoMan);
                OnValueChanged?.Invoke(Profile);
            };

            var sprite = new ScaledAnimatedTextureRect()
            {
                HorizontalAlignment = HAlignment.Center,
                VerticalAlignment = VAlignment.Center,
                Margin = new Thickness(2),
            };
            sprite.SetFromSpriteSpecifier(item.Icon, new(2, 2));
            button.AddChild(sprite);

            SkinList.AddChild(button);
        }
    }

    private void PopulateLaws(IPrototypeManager protoMan)
    {
        Laws.DisposeAllChildren();
        LawsPreview.DisposeAllChildren();
        var list = protoMan.EnumeratePrototypes<SiliconLawsetPrototype>()
                            .Where(x => x.Roundstart)
                            .OrderBy(x => x.Priority).ThenByDescending(x => $"lawset-{x.ID}-name")
                            .ToList();

        foreach (var item in list)
        {
            if (Profile?.SAIData.Lawset == item.ID)
                _lawset = item;

            var button = new Button()
            {
                Text = Loc.GetString($"lawset-{item.ID}-name"),
                Margin = new(4),
                HorizontalExpand = true,
                ToggleMode = true,
                MuteSounds = true,
                Pressed = Profile?.SAIData.Lawset == item.ID
            };

            button.OnPressed += args =>
            {
                Profile = Profile?.WithAILawset(item.ID);

                UserInterfaceManager.ClickSound();  // To avoid click spamming
                PopulateLaws(protoMan);
                OnValueChanged?.Invoke(Profile);
            };

            Laws.AddChild(button);
        }

        if (_lawset == null)
            return;

        foreach (var lawId in _lawset.Laws)
        {
            var law = protoMan.Index<SiliconLawPrototype>(lawId);
            var display = new LawDisplay(EntityUid.Invalid, law, null)
            {
                Margin = new(4)
            };

            LawsPreview.AddChild(display);
        }
    }
}
