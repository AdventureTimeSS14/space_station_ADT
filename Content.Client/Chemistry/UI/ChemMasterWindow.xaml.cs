using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared.Chemistry;
using Content.Shared.Chemistry.Reagent;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.Utility;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;
using System.Linq;
using System.Numerics;
using System.Threading.Tasks;
using Content.Shared.FixedPoint;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.Chemistry.UI
{
    /// <summary>
    /// Client-side UI used to control a <see cref="SharedChemMasterComponent"/>
    /// </summary>
    [GenerateTypedNameReferences]
    public sealed partial class ChemMasterWindow : FancyWindow
    {
        [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
        // ADT-Tweak Start
        // Events
        public event Action<BaseButton.ButtonEventArgs, ReagentButton, int, bool>? OnReagentButtonPressed;
        public event Action<int>? OnAmountButtonPressed;
        public event Action<int>? OnSortMethodChanged;
        public event Action<int>? OnTransferAmountChanged;
        public event Action<List<int>>? OnUpdateAmounts;
        public event Action<ReagentId, bool, bool>? OnTransferAllPressed;
        public event Action<ReagentId>? OnChooseReagentPressed;
        public event Action<ReagentId>? OnReagentToggledOn;
        public event Action<ReagentId>? OnReagentToggledOff;
        public event Action<ReagentId, int>? OnSelectReagentAmount;
        public event Action<ReagentId, int>? OnRemoveReagentAmount;
        public event Action<ReagentId>? OnClearReagentAmount;
        public event Action<int>? OnBottleSlotSelected;
        public event Action<int>? OnToggleBottleFillPressed;
        public event Action<int>? OnBottleSlotEjectPressed;
        public event Action<int>? OnRowEjectPressed;
        public event Action<int>? OnPillContainerSlotSelected;
        public event Action<int>? OnTogglePillContainerFillPressed;
        public event Action<int>? OnPillCanisterSelected;
        public event Action<int>? OnPillCanisterEjected;
        public event Action? OnTransferFromBottlePressed;
        public event Action<ReagentId, int>? OnTransferReagentFromBottle;

        // UI State
        public bool IsOutputTab => OutputTabs.CurrentTab == 0; // True for bottles tab, false for pills tab
        private bool _deleteMode = false;

        // Pill container buttons (3 containers × 10 slots each = 30 buttons)
        public readonly Button[] PillContainerStorageButtons;

        // Bottle container buttons (4 x 5 grid container for 20 buttons)
        public readonly Button[] BottleStorageButtons;
        public readonly Button[] BottleEjectButtons;
        public readonly Button[] RowEjectButtons;

        public readonly Button[] PillTypeButtons;

        // Configuration Constants
        private const string TransferringAmountColor = "#ffffff";
        private const int MaxAmountButtons = 16;
        private const string PillsRsiPath = "/Textures/Objects/Specific/Chemistry/pills.rsi";

        // Dosage and quantity limits
        private const int MaxPillDosage = 20;
        private const int MaxBottleDosage = 30;
        private const int AbsoluteMaxPills = 30;
        private const int AbsoluteMaxBottles = 20;

        // State
        private List<int> _amounts = new();
        private ReagentSortMethod _currentSortMethod = ReagentSortMethod.Alphabetical;
        private ChemMasterBoundUserInterfaceState? _lastState;
        private int _transferAmount = 50;
        private int _selectedBottleIndex = -1;
        private bool _labelLineEditFocused = false; // ADT-Tweak: Track if label field is being edited
        private Dictionary<ReagentId, float>? _lastSelectedReagentAmounts = null; // ADT-Tweak: Track selected reagents for label updates
        // ADT-Tweak End

        /// <summary>
        /// Create and initialize the chem master UI client-side. Creates the basic layout,
        /// actual data isn't filled in until the server sends data about the chem master.
        /// </summary>
        public ChemMasterWindow()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);

            //ADT-Tweak Start
            AmountLabel.HorizontalAlignment = HAlignment.Center;
            AmountLineEdit.OnTextEntered += SetAmount;

            DeleteAsFrequentButton.OnPressed += HandleDeleteModeToggled;
            SaveAsFrequentButton.OnPressed += HandleSaveAsFrequentPressed;
            //ADT-Tweak End

            // Pill type selection buttons, in total there are 20 pills.
            // Pill rsi file should have states named as pill1, pill2, and so on.
            var resourcePath = new ResPath(PillsRsiPath);
            var pillTypeGroup = new ButtonGroup();
            PillTypeButtons = new Button[20];
            for (uint i = 0; i < PillTypeButtons.Length; i++)
            {
                // For every button decide which stylebase to have
                // Every row has 10 buttons
                String styleBase = StyleBase.ButtonOpenBoth;
                uint modulo = i % 10;
                if (i > 0 && modulo == 0)
                    styleBase = StyleBase.ButtonOpenRight;
                else if (i > 0 && modulo == 9)
                    styleBase = StyleBase.ButtonOpenLeft;
                else if (i == 0)
                    styleBase = StyleBase.ButtonOpenRight;

                // Generate buttons
                PillTypeButtons[i] = new Button
                {
                    Access = AccessLevel.Public,
                    StyleClasses = { styleBase },
                    MaxSize = new Vector2(42, 28),
                    Group = pillTypeGroup
                };

                // Generate buttons textures
                var specifier = new SpriteSpecifier.Rsi(resourcePath, "pill" + (i + 1));
                TextureRect pillTypeTexture = new TextureRect
                {
                    Texture = specifier.Frame0(),               //ADT-Tweak
                    TextureScale = new Vector2(1.75f, 1.75f),
                    Stretch = TextureRect.StretchMode.KeepCentered,
                };

                PillTypeButtons[i].AddChild(pillTypeTexture);
                Grid.AddChild(PillTypeButtons[i]);
            }

            PillDosage.InitDefaultButtons();
            PillNumber.InitDefaultButtons();
            BottleDosage.InitDefaultButtons();
            BottleNumber.InitDefaultButtons();      //ADT-Tweak

            //ADT-Tweak Start

            // Set simple static validation for SpinBoxes
            PillNumber.IsValid = x => x >= 0 && x <= AbsoluteMaxPills;
            PillDosage.IsValid = x => x >= 0 && x <= MaxPillDosage;
            BottleNumber.IsValid = x => x >= 0 && x <= AbsoluteMaxBottles;
            BottleDosage.IsValid = x => x >= 0 && x <= MaxBottleDosage;

            // Update label when dosage or number changes
            PillDosage.ValueChanged += _ => UpdateLabelFromState();
            PillNumber.ValueChanged += _ => UpdateLabelFromState();
            BottleDosage.ValueChanged += _ => UpdateLabelFromState();
            BottleNumber.ValueChanged += _ => UpdateLabelFromState();

            BottleNumber.LineEditControl.OnTextChanged += _ => UpdateLabelFromState();
            BottleDosage.LineEditControl.OnTextChanged += _ => UpdateLabelFromState();
            PillNumber.LineEditControl.OnTextChanged += _ => UpdateLabelFromState();
            PillDosage.LineEditControl.OnTextChanged += _ => UpdateLabelFromState();

            // Bottle storage buttons with per-slot eject (eject on the right)
            BottleStorageButtons = new Button[20];
            BottleEjectButtons = new Button[20];
            RowEjectButtons = new Button[5];
            for (int row = 0; row < 5; row++)
            {
                for (int col = 0; col < 4; col++)
                {
                    int i = row * 4 + col;
                    var cell = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Horizontal,
                        HorizontalExpand = true
                    };

                    // Match Reagent Dispenser card sizing:
                    // - MainButton fills available space (HorizontalExpand/VerticalExpand).
                    // - Eject button fixed width 20px, full height, OpenLeft style, with centered label glyph.
                    var mainButton = new Button
                    {
                        HorizontalExpand = true,
                        VerticalExpand = true,
                        StyleClasses = { StyleBase.ButtonSquare },
                        ToggleMode = true
                    };

                    var ejectButton = new Button
                    {
                        VerticalExpand = true,
                        StyleClasses = { StyleBase.ButtonOpenLeft }
                    };
                    ejectButton.MinSize = new Vector2(20, 0);
                    ejectButton.MaxSize = new Vector2(20, float.MaxValue);

                    var ejectLabel = new Label
                    {
                        Text = Loc.GetString("chem-master-window-eject-container-button"),
                        VerticalAlignment = VAlignment.Center,
                        HorizontalAlignment = HAlignment.Center,
                        Margin = new Thickness(-7, -4, 0, 0)
                    };
                    ejectButton.AddChild(ejectLabel);

                    var buttonIndex = i;
                    mainButton.OnPressed += _ => OnToggleBottleFillPressed?.Invoke(buttonIndex);
                    ejectButton.OnPressed += _ => OnBottleSlotEjectPressed?.Invoke(buttonIndex);

                    BottleStorageButtons[i] = mainButton;
                    BottleEjectButtons[i] = ejectButton;

                    cell.AddChild(mainButton);
                    cell.AddChild(ejectButton);
                    BottleStorageGrid.AddChild(cell);
                }

                // Add row eject button
                var rowEjectButton = new Button
                {
                    Text = Loc.GetString("chem-master-window-eject-row-button"),
                    StyleClasses = { StyleBase.ButtonCaution },
                    VerticalExpand = true
                };
                int rowIndex = row;
                rowEjectButton.OnPressed += _ => OnRowEjectPressed?.Invoke(rowIndex);
                RowEjectButtons[row] = rowEjectButton;
                BottleStorageGrid.AddChild(rowEjectButton);
            }

            // Pill container storage with integrated controls (3 rows × 12 columns: choose, 10 pills, eject per row)
            PillContainerStorageButtons = new Button[30];
            var chooseButtons = new Button[3];
            var ejectButtons = new Button[3];

            for (int containerRow = 0; containerRow < 3; containerRow++)
            {
                // Choose button for this row
                var chooseButton = new Button
                {
                    Text = "Выбрать",
                    StyleClasses = { StyleBase.ButtonCaution },
                    MinSize = new Vector2(105, 30),
                    MaxSize = new Vector2(105, 30),
                    ToggleMode = true,
                    HorizontalExpand = true
                };

                var chooseIndex = containerRow;
                chooseButton.OnPressed += _ => OnPillCanisterSelected?.Invoke(chooseIndex);
                chooseButtons[containerRow] = chooseButton;
                PillContainerStorageGrid.AddChild(chooseButton);

                for (int pillSlot = 0; pillSlot < 10; pillSlot++)
                {
                    int i = containerRow * 10 + pillSlot;

                    var mainButton = new Button
                    {
                        StyleClasses = { StyleBase.ButtonSquare },
                        ToggleMode = true,
                        Margin = new Thickness(2),
                        MinSize = new Vector2(28, 28),
                        MaxSize = new Vector2(28, 28)
                    };

                    var buttonIndex = i;
                    mainButton.OnPressed += _ => OnTogglePillContainerFillPressed?.Invoke(buttonIndex);

                    PillContainerStorageButtons[i] = mainButton;
                    PillContainerStorageGrid.AddChild(mainButton);
                }

                var ejectButton = new Button
                {
                    Text = "Извлечь",
                    StyleClasses = { StyleBase.ButtonCaution },
                    MinSize = new Vector2(105, 30),
                    MaxSize = new Vector2(105, 30),
                    HorizontalExpand = true,
                    HorizontalAlignment = HAlignment.Stretch
                };

                var ejectIndex = containerRow;
                ejectButton.OnPressed += _ => OnPillCanisterEjected?.Invoke(ejectIndex);
                ejectButtons[containerRow] = ejectButton;
                PillContainerStorageGrid.AddChild(ejectButton);
            }
            // ADT-Tweak End

            // Ensure label length is within the character limit.
            LabelLineEdit.IsValid = s => s.Length <= SharedChemMaster.LabelMaxLength;

            // ADT-Tweak Start

            // Track focus to prevent overwriting user input
            LabelLineEdit.OnFocusEnter += _ => _labelLineEditFocused = true;
            LabelLineEdit.OnFocusExit += _ => _labelLineEditFocused = false;

            Tabs.SetTabTitle(0, Loc.GetString("chem-master-window-buffer-text-label"));

            // Set titles for the new output tabs
            OutputTabs.SetTabTitle(0, Loc.GetString("chem-master-window-bottles-tab"));
            OutputTabs.SetTabTitle(1, Loc.GetString("chem-master-window-pills-tab"));
            // Update label when switching between bottles and pills tabs
            OutputTabs.OnTabChanged += _ => UpdateLabelFromState();

            SortMethod.AddItem(
                Loc.GetString("chem-master-window-sort-method-Amount-text"),
                (int)ReagentSortMethod.Amount);

            SortMethod.AddItem(
                Loc.GetString("chem-master-window-sort-method-Alphabetical-text"),
                (int)ReagentSortMethod.Alphabetical);

            SortMethod.AddItem(
                Loc.GetString("chem-master-window-sort-method-Time-text"),
                (int)ReagentSortMethod.Time);

            // Set minimum size for sort method button
            SortMethod.MinSize = new Vector2(300, 29);
            SortMethod.HorizontalAlignment = HAlignment.Stretch;

            SortMethod.OnItemSelected += HandleChildPressed;


            BufferTransferButton.OnPressed += HandleDiscardTransferPress;
            BufferDiscardButton.OnPressed += HandleDiscardTransferPress;


            CreateAmountButtons();
            //ADT-Tweak End
        }

        // ADT-Tweak Start: Input container amount buttons

        private void CreateAmountButtons()
        {
            AmountButtons.DisposeAllChildren();

            int buttonsToShow = Math.Min(_amounts.Count, MaxAmountButtons);

            for (int i = 0; i < buttonsToShow; i++)
            {
                var styleClass = StyleBase.ButtonOpenBoth;
                var amount = _amounts[i];
                var columns = AmountButtons.Columns;

                if (i == 0 || i % columns == 0)
                    styleClass = StyleBase.ButtonOpenRight;

                if ((i + 1) % columns == 0)
                    styleClass = StyleBase.ButtonOpenLeft;

                var button = new Button()
                {
                    Text = amount.ToString(),
                    MinSize = new(10, 10),
                    StyleClasses = { styleClass },
                    HorizontalExpand = true
                };

                button.OnPressed += _ => HandleAmountButtonPressed(amount);
                AmountButtons.AddChild(button);
            }
        }

        private void HandleSaveAsFrequentPressed(BaseButton.ButtonEventArgs args)
        {
            if (!int.TryParse(AmountLineEdit.Text, out var amount))
            {
                ShowWarningMessage(Loc.GetString("chem-master-window-amount-empty"));
                return;
            }

            if (amount > 1000)  // Limit maximum amount to 1000
            {
                ShowWarningMessage(Loc.GetString("chem-master-window-amount-too-much"));
                return;
            }

            if (amount <= 0)
            {
                ShowWarningMessage(Loc.GetString("chem-master-window-amount-invalid"));
                return;
            }

            if (_amounts.Any(a => amount == a))
            {
                ShowWarningMessage(Loc.GetString("chem-master-window-amount-duplicate"));
                return;
            }

            if (_amounts.Count >= MaxAmountButtons)  // Limit maximum number of templates to 16
            {
                ShowWarningMessage(Loc.GetString("chem-master-window-amount-limit-reached"));
                return;
            }

            _amounts.Add(amount);
            _amounts.Sort();
            CreateAmountButtons();
            OnUpdateAmounts?.Invoke(_amounts);
            AmountLineEdit.SetText(string.Empty);
        }

        private async void ShowWarningMessage(string message)
        {
            WarningLabel.Text = message;
            WarningLabel.Visible = true;

            // Clear the warning message after 3 seconds
            await Task.Delay(3000);
            WarningLabel.Text = string.Empty;
            WarningLabel.Visible = false;
        }
        // ADT-Tweak End


        // ADT-Tweak Start: Amount getters for selected reagents label
        private bool TryGetSelectedAmount(ReagentId reagent, ChemMasterBoundUserInterfaceState? state, out float selectedAmount)
        {
            selectedAmount = 0;
            state ??= _lastState;

            if (state?.SelectedReagentAmounts == null || state.SelectedReagentAmounts.Count == 0)
                return false;

            // First try direct lookup (works if ReagentId matches exactly including Data)
            if (state.SelectedReagentAmounts.TryGetValue(reagent, out selectedAmount))
                return selectedAmount > 0;

            // If direct lookup fails, try comparing by Equals (handles cases where Data might differ)
            foreach (var kvp in state.SelectedReagentAmounts)
            {
                if (kvp.Key.Equals(reagent))
                {
                    selectedAmount = kvp.Value;
                    return selectedAmount > 0;
                }
            }

            // If Equals also fails, try comparing by Prototype string only
            // This handles cases where ReagentId instances have different Data but same Prototype
            foreach (var kvp in state.SelectedReagentAmounts)
            {
                if (kvp.Key.Prototype == reagent.Prototype)
                {
                    selectedAmount = kvp.Value;
                    return selectedAmount > 0;
                }
            }

            return false;
        }

        private float GetTotalSelectedReagentAmount()
        {
            if (_lastState?.SelectedReagentAmounts == null)
                return 0;

            float total = 0;
            foreach (var amount in _lastState.SelectedReagentAmounts.Values)
            {
                total += amount;
            }
            return total;
        }
        // ADT-Tweak End

        // ADT-Tweak Start
        private void UpdateDosageAndNumberFromSelection()
        {
            var totalAmount = GetTotalSelectedReagentAmount();

            if (totalAmount == 0)
            {
                // No reagents selected - set to 0
                PillNumber.Value = 0;
                PillDosage.Value = 0;
                BottleNumber.Value = 0;
                BottleDosage.Value = 0;
                return;
            }

            // Update pills: if less than 20 units, make 1 pill with that dosage
            // if 20 or more, make pills with max dosage (20) and calculate number
            if (totalAmount < MaxPillDosage)
            {
                PillNumber.Value = 1;
                PillDosage.Value = (int)totalAmount;
            }
            else
            {
                PillDosage.Value = MaxPillDosage;
                PillNumber.Value = (int)Math.Min(totalAmount / MaxPillDosage, AbsoluteMaxPills);
            }

            // Update bottles: if less than 30 units, make 1 bottle with that dosage
            // if 30 or more, make bottles with max dosage (30) and calculate number
            if (totalAmount < MaxBottleDosage)
            {
                BottleNumber.Value = 1;
                BottleDosage.Value = (int)totalAmount;
            }
            else
            {
                BottleDosage.Value = MaxBottleDosage;
                BottleNumber.Value = (int)Math.Min(totalAmount / MaxBottleDosage, AbsoluteMaxBottles);
            }
        }

        private void HandleDeleteModeToggled(BaseButton.ButtonEventArgs args)
        {
            _deleteMode = DeleteAsFrequentButton.Pressed;
        }

        private void HandleAmountButtonPressed(int amount)
        {
            if (_deleteMode)
            {
                _amounts.Remove(amount);
                CreateAmountButtons();
                OnUpdateAmounts?.Invoke(_amounts);
            }
            else
            {
                OnAmountButtonPressed?.Invoke(amount);
                SetAmountText(amount.ToString());
            }
        }

        private void HandleDiscardTransferPress(BaseButton.ButtonEventArgs args)
        {
            var bufferButtons = BufferInfo.Children
                .Where(c => c is Button)
                .Cast<Button>();

            foreach (var button in bufferButtons)
            {
                var text = BufferTransferButton.Pressed ? "transfer" : "discard";
                button.Text = Loc.GetString($"chem-master-window-{text}-button-text");
            }
        }

        private void UpdatePillCanisterButtonStates()
        {
            if (_lastState == null)
                return;

            // Update choose buttons state - choose buttons are now in the unified PillContainerStorageGrid at indices 0, 12, 24
            var pillGrid = FindControl<GridContainer>("PillContainerStorageGrid");

            if (pillGrid != null)
            {
                for (int i = 0; i < 3; i++)
                {
                    var chooseButton = pillGrid.Children.ElementAt(i * 12) as Button;
                    if (chooseButton != null)
                    {
                        var isSelected = _lastState.SelectedPillCanisterForCreation == i;
                        chooseButton.Pressed = isSelected;

                        // Change background color using Modulate
                        chooseButton.Modulate = isSelected ? Color.LimeGreen : Color.Green;

                        // Keep text color always white by overriding Label's modulate
                        if (chooseButton.Label != null)
                        {
                            chooseButton.Label.ModulateSelfOverride = Color.White;
                        }
                    }
                }
            }
        }

        private void HandleSortMethodChange(int newSortMethod)
        {
            if (newSortMethod == (int)_currentSortMethod)
                return;

            _currentSortMethod = (ReagentSortMethod)newSortMethod;
            SortMethod.SelectId(newSortMethod);

            SortUpdated();
        }

        private void HandleChildPressed(OptionButton.ItemSelectedEventArgs args)
        {
            HandleSortMethodChange(args.Id);
            OnSortMethodChanged?.Invoke(args.Id);
        }

        private void SortUpdated()
        {
            if (_lastState == null)
                return;

            UpdateState(_lastState);
        }

        private bool ValidateAmount(string newText, bool invokeEvent = true)
        {
            if (string.IsNullOrWhiteSpace(newText) || !int.TryParse(newText, out int amount) || amount <= 0)
            {
                AmountLineEdit.SetText(string.Empty);
                return false;
            }

            _transferAmount = amount;

            if (invokeEvent)
                OnTransferAmountChanged?.Invoke(amount);

            return true;
        }

        private void SetAmount(LineEdit.LineEditEventArgs args) =>
            SetAmountText(args.Text);

        private void SetAmountText(string newText, bool invokeEvent = true)
        {
            if (newText == _transferAmount.ToString() || !ValidateAmount(newText, invokeEvent))
                return;

            var localizedAmount = Loc.GetString(
                "chem-master-window-transferring-label",
                ("quantity", newText),
                ("color", TransferringAmountColor));

            AmountLabel.Text = localizedAmount;
            AmountLineEdit.SetText(string.Empty);
        }
        //ADT-Tweak End

        private ReagentButton MakeReagentButton(string text, ReagentId id, bool isBuffer)
        {
            var reagentTransferButton = new ReagentButton(text, id, isBuffer);
            reagentTransferButton.OnPressed += args
                => OnReagentButtonPressed?.Invoke(args, reagentTransferButton, _transferAmount, OutputTabs.CurrentTab == 0);  //ADT-Tweak
            return reagentTransferButton;
        }
        /// <summary>
        /// Conditionally generates a set of reagent buttons based on the supplied boolean argument.
        /// This was moved outside of BuildReagentRow to facilitate conditional logic, stops indentation depth getting out of hand as well.
        /// </summary>
        private ReagentButton? CreateReagentTransferButton(ReagentId reagent, bool isBuffer, bool addReagentButtons)
        {
            if (!addReagentButtons)
                return null; // Return an empty list if reagentTransferButton creation is disabled.

            // ADT-Tweak-Start: Use the appropriate toggle (buffer vs. pill) when determining the text
            var isTransfer = BufferTransferButton.Pressed;
            var text = isTransfer
                ? "transfer"
                : "discard";

            var reagentTransferButton = MakeReagentButton(
                Loc.GetString($"chem-master-window-{text}-button"),
                reagent,
                isBuffer
            );

            return reagentTransferButton;
            // ADT-Tweak-End
        }

        /// <summary>
        /// Update the UI state when new state data is received from the server.
        /// </summary>
        /// <param name="state">State data sent by the server.</param>
        public void UpdateState(BoundUserInterfaceState state)
        {
            var castState = (ChemMasterBoundUserInterfaceState)state;
            // ADT-Tweak Start
            _lastState = castState;
            HandleSortMethodChange(castState.SortMethod);
            UpdatePanelInfo(castState);

            // Check if selected reagents changed or UpdateLabel flag is set
            bool selectedReagentsChanged = _lastSelectedReagentAmounts == null ||
                !_lastSelectedReagentAmounts.SequenceEqual(castState.SelectedReagentAmounts ?? new Dictionary<ReagentId, float>());

            if (selectedReagentsChanged)
                _lastSelectedReagentAmounts = castState.SelectedReagentAmounts != null
                    ? new Dictionary<ReagentId, float>(castState.SelectedReagentAmounts)
                    : null;

            // Update label if field is not being edited and either UpdateLabel flag is set or reagents changed
            if (!_labelLineEditFocused && (castState.UpdateLabel || selectedReagentsChanged))
                LabelLine = GenerateLabel(castState);

            SetAmountText(castState.TransferringAmount.ToString(), false);  // ADT-Tweak

            // compare list contents instead of references
            if (!_amounts.SequenceEqual(castState.Amounts))
            {
                _amounts = castState.Amounts;
                _amounts.Sort();
                CreateAmountButtons();
            }

            InputEjectButton.Disabled = castState.ContainerInfo is null;

            // Update Number and Dosage based on selected reagents
            UpdateDosageAndNumberFromSelection();

            // Check if we can create pills
            var totalSelectedAmount = GetTotalSelectedReagentAmount();
            var pillTotalNeeded = PillNumber.Value * PillDosage.Value;
            var canCreatePills = castState.BufferReagents.Count > 0 &&
                                  PillNumber.Value > 0 &&
                                  PillDosage.Value > 0 &&
                                  pillTotalNeeded <= totalSelectedAmount;
            CreatePillButton.Disabled = !canCreatePills;

            // Check if we can create bottles
            var bottleTotalNeeded = BottleNumber.Value * BottleDosage.Value;
            var canCreateBottles = castState.BufferReagents.Count > 0 &&
                                    BottleNumber.Value > 0 &&
                                    BottleDosage.Value > 0 &&
                                    bottleTotalNeeded <= totalSelectedAmount;
            CreateBottleButton.Disabled = !canCreateBottles;

            UpdateBottleStorage(castState);
            UpdatePillContainerStorage(castState);
            UpdatePillCanisterButtonStates();
            // ADT-Tweak-End
        }

        //ADT-Tweak Start: Calculate mixed color based on reagent percentages, similar to how beakers display color and update interface
        private Color GetMixedReagentColor(List<ReagentQuantity> reagents)
        {
            if (reagents == null || !reagents.Any())
                return Color.White;

            Color mixColor = default;
            var runningTotalQuantity = FixedPoint2.Zero;
            bool first = true;

            foreach (var reagent in reagents)
            {
                runningTotalQuantity += reagent.Quantity;

                if (!_prototypeManager.TryIndex(reagent.Reagent.Prototype, out ReagentPrototype? proto))
                {
                    continue;
                }

                if (first)
                {
                    first = false;
                    mixColor = proto.SubstanceColor;
                    continue;
                }

                var interpolateValue = reagent.Quantity.Float() / runningTotalQuantity.Float();
                mixColor = Color.InterpolateBetween(mixColor, proto.SubstanceColor, interpolateValue);
            }

            return mixColor;
        }

        private void UpdateBottleStorage(ChemMasterBoundUserInterfaceState state)
        {
            for (int i = 0; i < BottleStorageButtons.Length; i++)
            {
                var button = BottleStorageButtons[i];
                var info = state.StoredBottles[i];
                if (info != null)
                {
                    button.Text = $"{info.CurrentVolume}/{info.MaxVolume}";
                    if (info.Reagents != null && info.Reagents.Any())
                    {
                        // Calculate mixed color based on reagent percentages
                        button.Modulate = GetMixedReagentColor(info.Reagents);
                    }
                    else
                    {
                        button.Modulate = Color.White;
                    }
                    // Enable toggle mode when bottle is present
                    button.ToggleMode = true;

                    button.Pressed = state.SelectedBottleSlot == i || state.SelectedBottleForFill == i;
                }
                else
                {
                    button.Text = Loc.GetString("chem-master-window-bottle-storage-empty");
                    button.Modulate = Color.Gray;
                    button.Pressed = false;
                    // Disable toggle mode when slot is empty
                    button.ToggleMode = false;
                }

                // Enable eject only if a bottle exists in the slot.
                if (BottleEjectButtons != null && BottleEjectButtons.Length > i && BottleEjectButtons[i] != null)
                    BottleEjectButtons[i].Disabled = info == null;
            }

            // Update selected bottle index and contents display
            _selectedBottleIndex = state.SelectedBottleForFill;
            UpdateBottleContents(state);
        }

        private void UpdateBottleContents(ChemMasterBoundUserInterfaceState state)
        {
            BottleContentsInfo.Children.Clear();

            if (_selectedBottleIndex < 0 || _selectedBottleIndex >= state.StoredBottles.Count || state.StoredBottles[_selectedBottleIndex] == null)
            {
                BottleContentsInfo.Children.Add(new Label { Text = Loc.GetString("chem-master-window-no-bottle-selected-text") });
                return;
            }

            var bottleInfo = state.StoredBottles[_selectedBottleIndex];
            if (bottleInfo == null) // Safety check to avoid null reference warning
            {
                BottleContentsInfo.Children.Add(new Label { Text = Loc.GetString("chem-master-window-no-bottle-selected-text") });
                return;
            }

             // Header - only show volume info
            var headerHBox = new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal
            };
            headerHBox.AddChild(new Label
            {
                Text = Loc.GetString("chem-master-window-bottle-label",
                    ("current", bottleInfo.CurrentVolume),
                    ("max", bottleInfo.MaxVolume)),
                StyleClasses = { StyleNano.StyleClassLabelSecondaryColor }
            });
            BottleContentsInfo.AddChild(headerHBox);

            // Check if bottle has reagents
            if (bottleInfo.Reagents == null || !bottleInfo.Reagents.Any())
            {
                BottleContentsInfo.Children.Add(new Label { Text = Loc.GetString("chem-master-window-bottle-storage-empty") });
                return;
            }

            // Reagents - using simple rows
            int rowCount = 0;
            foreach (var reagent in bottleInfo.Reagents)
            {
                _prototypeManager.TryIndex(reagent.Reagent.Prototype, out ReagentPrototype? proto);
                var name = proto?.LocalizedName ?? Loc.GetString("chem-master-window-unknown-reagent-text");
                var reagentColor = proto?.SubstanceColor ?? default(Color);

                var row = BuildSimpleReagentRow(reagentColor, rowCount++, name, reagent.Quantity, reagent.Reagent);
                BottleContentsInfo.AddChild(row);
            }
        }
        // ADT-Tweak End

        // ADT-Tweak Start: Build a simplified reagent row for bottle contents display with only name, quantity, color control, and transfer button
        private Control BuildSimpleReagentRow(Color reagentColor, int rowCount, string name, FixedPoint2 quantity, ReagentId reagentId)
        {
            // Colors for alternating rows
            var rowColor1 = Color.FromHex("#1B1B1E");
            var rowColor2 = Color.FromHex("#202025");
            var currentRowColor = (rowCount % 2 == 1) ? rowColor1 : rowColor2;

            // Use row color as fallback if reagent has no color
            if (reagentColor == default)
            {
                reagentColor = currentRowColor;
            }

            // Create the row container
            var rowContainer = new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal
            };

            // Stats container with name and quantity
            var statsContainer = new BoxContainer
            {
                MinWidth = 130,
                Orientation = LayoutOrientation.Horizontal,
                HorizontalExpand = true,
                Children =
                {
                    new Label
                    {
                        Text = $"{name}: ",
                        HorizontalAlignment = HAlignment.Left
                    },
                    new Label
                    {
                        Text = $"{quantity}u",
                        StyleClasses = { StyleNano.StyleClassLabelSecondaryColor },
                        HorizontalAlignment = HAlignment.Left
                    }
                }
            };

            // Color panel for reagent color
            var colorPanel = new PanelContainer
            {
                Name = "colorPanel",
                VerticalExpand = true,
                MinWidth = 4,
                PanelOverride = new StyleBoxFlat
                {
                    BackgroundColor = reagentColor
                },
                Margin = new Thickness(0, 1)
            };

            var transferButton = new Button
            {
                Text = "↑",
                MinWidth = 30,
                MaxWidth = 30,
                StyleClasses = { StyleBase.ButtonOpenLeft }
            };
            // Make button text bold
            if (transferButton.Label != null)
            {
                var resCache = IoCManager.Resolve<IResourceCache>();
                var boldFont = resCache.NotoStack(variation: "Bold", size: 12);
                transferButton.Label.FontOverride = boldFont;
            }
            transferButton.OnPressed += _ => OnTransferReagentFromBottle?.Invoke(reagentId, _transferAmount);


            rowContainer.AddChild(statsContainer);
            rowContainer.AddChild(colorPanel);
            rowContainer.AddChild(transferButton);

            // Wrap in panel container for striped row background
            return new PanelContainer
            {
                PanelOverride = new StyleBoxFlat(currentRowColor),
                Children = { rowContainer }
            };
        }
        //ADT-Tweak End

        // ADT-Tweak Start: Pill container storage update
        private void UpdatePillContainerStorage(ChemMasterBoundUserInterfaceState state)
        {
            for (int i = 0; i < PillContainerStorageButtons.Length; i++)
            {
                var button = PillContainerStorageButtons[i];

                var containerIndex = i / 10;
                var slotIndex = i % 10;

                if (containerIndex < state.StoredPillContainers.Count)
                {
                    var containerInfo = state.StoredPillContainers[containerIndex];

                    if (containerInfo != null)
                    {
                        // Container is present - enable interaction and show pill contents
                        var maxPills = (int)containerInfo.MaxVolume;
                        var pillEntities = state.PillContainers[containerIndex];

                        if (slotIndex < pillEntities.Count && pillEntities[slotIndex])
                        {
                            // This slot has a pill - show pill sprite from actual pill prototype
                            button.Text = "";

                            // Get the pill type from the state data
                            if (containerIndex < state.PillTypes.Count &&
                                slotIndex < state.PillTypes[containerIndex].Count)
                            {
                                var pillType = state.PillTypes[containerIndex][slotIndex];

                                if (pillType > 0 && pillType <= 20)
                                {

                                    var spriteNumber = pillType + 1;
                                    var specifier = new SpriteSpecifier.Rsi(new ResPath(PillsRsiPath), $"pill{spriteNumber}");

                                    // Create texture rect for the pill sprite
                                    var pillTexture = new TextureRect
                                    {
                                        Texture = specifier.Frame0(),
                                        TextureScale = new Vector2(1.5f, 1.5f),
                                        Stretch = TextureRect.StretchMode.KeepCentered,
                                        HorizontalAlignment = HAlignment.Center,
                                        VerticalAlignment = VAlignment.Center
                                    };

                                    // Clear existing children and add the pill texture
                                    button.Children.Clear();
                                    button.AddChild(pillTexture);
                                    button.Modulate = Color.White;
                                }
                                else
                                {
                                    // Fallback to default pill sprite if pill type is 0 or invalid
                                    var specifier = new SpriteSpecifier.Rsi(new ResPath(PillsRsiPath), "pill1");
                                    var pillTexture = new TextureRect
                                    {
                                        Texture = specifier.Frame0(),
                                        TextureScale = new Vector2(1.5f, 1.5f),
                                        Stretch = TextureRect.StretchMode.KeepCentered,
                                        HorizontalAlignment = HAlignment.Center,
                                        VerticalAlignment = VAlignment.Center
                                    };

                                    button.Children.Clear();
                                    button.AddChild(pillTexture);
                                    button.Modulate = Color.White;
                                }
                            }
                            else
                            {
                                // Fallback if pill type data is not available
                                var specifier = new SpriteSpecifier.Rsi(new ResPath(PillsRsiPath), "pill1");
                                var pillTexture = new TextureRect
                                {
                                    Texture = specifier.Frame0(),
                                    TextureScale = new Vector2(1.5f, 1.5f),
                                    Stretch = TextureRect.StretchMode.KeepCentered,
                                    HorizontalAlignment = HAlignment.Center,
                                    VerticalAlignment = VAlignment.Center
                                };

                                button.Children.Clear();
                                button.AddChild(pillTexture);
                                button.Modulate = Color.White;
                            }
                        }
                        else if (slotIndex < maxPills)
                        {
                            // This slot is empty but available
                            button.Children.Clear();
                            button.Modulate = Color.Gray;
                        }
                        else
                        {
                            // This slot is beyond container capacity
                            button.Children.Clear();
                            button.Modulate = Color.DarkGray;
                        }

                        // Enable toggle mode when container is present
                        button.ToggleMode = true;
                        button.Pressed = state.SelectedPillContainerSlot == i || state.SelectedPillContainerForFill == i;
                    }
                    else
                    {
                        // No container in this slot - disable
                        button.Children.Clear();
                        button.Modulate = Color.DarkGray;
                        button.Pressed = false;
                        button.ToggleMode = false;
                    }
                }
                else
                {
                    button.Children.Clear();
                    button.Modulate = Color.DarkGray;
                    button.Pressed = false;
                    button.ToggleMode = false;
                }
            }
        }
        // ADT-Tweak End

        // ADT-Tweak Start: Generate Label for pills and bottles on creation
        private string GenerateLabel(ChemMasterBoundUserInterfaceState state)
        {
            // Check if we have selected reagents
            if (state.SelectedReagentAmounts == null || state.SelectedReagentAmounts.Count == 0)
                return "";

            // Determine if we're on bottles or pills tab
            bool isBottles = IsOutputTab;
            uint dosage = isBottles ? (uint)BottleDosage.Value : (uint)PillDosage.Value;

            if (dosage == 0)
                return "";

            // Calculate total selected amount
            FixedPoint2 totalSelectedAmount = FixedPoint2.Zero;
            foreach (var amount in state.SelectedReagentAmounts.Values)
            {
                totalSelectedAmount += FixedPoint2.New(amount);
            }

            if (totalSelectedAmount <= 0)
                return "";

            var scale = FixedPoint2.New(dosage) / totalSelectedAmount;

            // Calculate amount per unit for each reagent
            var reagentAmounts = new Dictionary<ReagentId, FixedPoint2>();
            var totalForWithdrawal = FixedPoint2.Zero;
            var reagentList = state.SelectedReagentAmounts.ToList();

            // Calculate for all reagents except the last
            for (int i = 0; i < reagentList.Count - 1; i++)
            {
                var (reagentId, selectedAmount) = reagentList[i];
                var scaledAmount = FixedPoint2.New(selectedAmount) * scale;
                reagentAmounts[reagentId] = scaledAmount;
                totalForWithdrawal += scaledAmount;
            }

            // For the last reagent, use remaining to ensure exact dosage
            if (reagentList.Count > 0)
            {
                var lastReagent = reagentList[reagentList.Count - 1].Key;
                var remaining = FixedPoint2.New(dosage) - totalForWithdrawal;
                reagentAmounts[lastReagent] = remaining;
            }

            // Format the label - use compact format to fit more reagents

            var parts = new List<string>();

            foreach (var (reagentId, amount) in reagentAmounts)
            {
                // Try to get reagent prototype for the name
                if (_prototypeManager.TryIndex<ReagentPrototype>(reagentId.Prototype, out var reagentProto))
                {
                    var reagentName = Loc.GetString(reagentProto.LocalizedName);
                    parts.Add($"{reagentName}:{amount:F0}u");
                }
            }

            return string.Join("/", parts);
        }

        private void UpdateLabelFromState()
        {
            if (_lastState != null && !_labelLineEditFocused)
            {
                var newLabel = GenerateLabel(_lastState);
                if (!string.IsNullOrEmpty(newLabel))
                {
                    LabelLine = newLabel;
                }
            }
        }

        /// <summary>
        /// Update the container, buffer, and packaging panels.
        /// </summary>
        /// <param name="state">State data for the dispenser.</param>
        private void UpdatePanelInfo(ChemMasterBoundUserInterfaceState state)
        {
            BufferTransferButton.Pressed = state.Mode == ChemMasterMode.Transfer;
            BufferDiscardButton.Pressed = state.Mode == ChemMasterMode.Discard;
            BuildContainerUI(ContainerInfoContainer, state.ContainerInfo, true); // ADT-Tweak
            BuildBufferInfo(state);
        }

        private void BuildBufferInfo(ChemMasterBoundUserInterfaceState state)
        {
            BufferInfo.Children.Clear();

            if (!state.BufferReagents.Any())
            {
                BufferInfo.Children.Add(new Label { Text = Loc.GetString("chem-master-window-buffer-empty-text") });
                return;
            }

            var bufferHBox = new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal
            };

            BufferInfo.AddChild(bufferHBox);

            var bufferLabel = new Label { Text = $"{Loc.GetString("chem-master-window-buffer-label")} " };
            bufferHBox.AddChild(bufferLabel);
            var bufferVol = new Label
            {
                Text = $"{state.BufferCurrentVolume}u",
                StyleClasses = { StyleNano.StyleClassLabelSecondaryColor }
            };
            bufferHBox.AddChild(bufferVol);

            // ADT-Tweak Start
            var bufferReagents = state.BufferReagents;
            if (_currentSortMethod == ReagentSortMethod.Amount)
                bufferReagents = bufferReagents.OrderByDescending(x => x.Quantity).ToList();
            else if (_currentSortMethod == ReagentSortMethod.Alphabetical)
                bufferReagents = bufferReagents.OrderBy(x =>
                {
                    _prototypeManager.TryIndex(x.Reagent.Prototype, out ReagentPrototype? proto);
                    var localized = proto?.LocalizedName ?? string.Empty;
                    return localized;
                }).ToList();
            else
                bufferReagents = bufferReagents.OrderBy(x => x.Reagent.Prototype).ToList();

            HandleBuffer(_currentSortMethod == ReagentSortMethod.Time ? state.BufferReagents : bufferReagents, state);
            // ADT-Tweak End
        }

        // ADT-Tweak Start
        private void HandleBuffer(IEnumerable<ReagentQuantity> reagents, ChemMasterBoundUserInterfaceState state)
        {
            var rowCount = 0;
            foreach (var (reagentId, quantity) in reagents)
            {
                _prototypeManager.TryIndex(reagentId.Prototype, out ReagentPrototype? proto);

                var name = proto?.LocalizedName ?? Loc.GetString("chem-master-window-unknown-reagent-text");
                var reagentColor = proto?.SubstanceColor ?? default;

                var row = BuildReagentRow(
                    reagentColor,
                    rowCount++,
                    name,
                    reagentId,
                    quantity,
                    true,
                    true,
                    state);
                BufferInfo.Children.Add(row);
            }
        }
        // ADT-Tweak End

        private void BuildContainerUI(Control control, ContainerInfo? info, bool addReagentButtons)
        {
            control.Children.Clear();

            if (info is null)
            {
                control.Children.Add(new Label
                {
                    Text = Loc.GetString("chem-master-window-no-container-loaded-text")
                });
                return;
            }

            // Name of the container and its fill status (Ex: 44/100u)
            control.Children.Add(new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal,
                Children =
                {
                    new Label { Text = $"{info.DisplayName}: " },
                    new Label
                    {
                        Text = $"{info.CurrentVolume}/{info.MaxVolume}",
                        StyleClasses = { StyleNano.StyleClassLabelSecondaryColor }
                    }
                }
            });
            // Initialises rowCount to allow for striped rows
            var rowCount = 0;

            // Handle entities if they are not null
            if (info.Entities != null)
            {
                foreach (var (id, quantity) in info.Entities.Select(x => (x.Id, x.Quantity)))
                {
                    control.Children.Add(BuildReagentRow(default, rowCount++, id, default, quantity, false, addReagentButtons));
                }
            }

            // Handle reagents if they are not null
            if (info.Reagents != null)
            {
                foreach (var reagent in info.Reagents)
                {
                    _prototypeManager.TryIndex(reagent.Reagent.Prototype, out ReagentPrototype? proto);
                    var name = proto?.LocalizedName ?? Loc.GetString("chem-master-window-unknown-reagent-text");
                    var reagentColor = proto?.SubstanceColor ?? default(Color);

                    control.Children.Add(BuildReagentRow(reagentColor, rowCount++, name, reagent.Reagent, reagent.Quantity, false, addReagentButtons));
                }
            }
        }
        /// <summary>
        /// Take reagent/entity data and present rows, labels, and buttons appropriately. todo sprites?
        /// </summary>
        private Control BuildReagentRow(Color reagentColor, int rowCount, string name, ReagentId reagent, FixedPoint2 quantity, bool isBuffer, bool addReagentButtons, ChemMasterBoundUserInterfaceState? state = null)
        {
            //Colors rows and sets fallback for reagentcolor to the same as background, this will hide colorPanel for entities hopefully
            var rowColor1 = Color.FromHex("#1B1B1E");
            var rowColor2 = Color.FromHex("#202025");
            var currentRowColor = (rowCount % 2 == 1) ? rowColor1 : rowColor2;
            if (reagentColor == default || !addReagentButtons)
            {
                reagentColor = currentRowColor;
            }
            //this calls the separated button builder, and stores the return to render after labels
            var reagentButtonConstructor = CreateReagentTransferButton(reagent, isBuffer, addReagentButtons);   // ADT-Tweak

            // ADT-Tweak Start
            var rowContainer = new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal
            };

            var statsContainer = new BoxContainer
            {
                MinWidth = 130,
                Orientation = LayoutOrientation.Horizontal,
                Children =
                {
                    new Label
                    {
                        Text = $"{name}: ",
                        HorizontalAlignment = HAlignment.Left
                    },
                    new Label
                    {
                        Text = $"{quantity}u",
                        StyleClasses = { StyleNano.StyleClassLabelSecondaryColor },
                        HorizontalAlignment = HAlignment.Left
                    }
                }
            };

            // Padding
            var padding = new Control { HorizontalExpand = true };

            rowContainer.AddChild(statsContainer);
            rowContainer.AddChild(padding);

            // Create color panel to add later
            var colorPanel = new PanelContainer
            {
                Name = "colorPanel",
                VerticalExpand = true,
                MinWidth = 4,
                PanelOverride = new StyleBoxFlat
                {
                    BackgroundColor = reagentColor
                },
                Margin = new Thickness(0, 1)
            };

            // Reagent selection with amount tracking
            if (reagentButtonConstructor != null)
            {
                if (isBuffer && reagent != default)
                {
                    // Left container for selected amount display
                    var leftContainer = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Vertical,
                        VerticalExpand = true,
                        MinWidth = 120,
                        HorizontalExpand = true
                    };
                    // Always show the container for consistent layout
                    var selectedLabel = new Label
                    {
                        StyleClasses = { StyleNano.StyleClassLabelSecondaryColor },
                        HorizontalAlignment = HAlignment.Left,
                        VerticalAlignment = VAlignment.Center,
                        HorizontalExpand = true
                    };

                    // Check if this reagent has a selected amount
                    var currentState = state ?? _lastState;

                    // Initialize text
                    selectedLabel.Text = Loc.GetString("chem-master-window-reagent-empty");

                    // Use the existing TryGetSelectedAmount method which handles comparison properly
                    if (TryGetSelectedAmount(reagent, currentState, out var selectedAmount))
                    {
                        selectedLabel.Text = Loc.GetString("chem-master-window-reagent-selected",
                            ("amount", selectedAmount));
                    }

                    leftContainer.AddChild(selectedLabel);

                    rowContainer.AddChild(leftContainer);

                    // Add color panel after selected label
                    rowContainer.AddChild(colorPanel);

                    // Buttons container
                    var buttonsContainer = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Horizontal,
                        VerticalExpand = true
                    };

                    // Select button
                    var selectButton = new Button()
                    {
                        Text = Loc.GetString("chem-master-window-select-button"),
                        StyleClasses = { StyleBase.ButtonSquare },
                        MinSize = new Vector2(60, 0)
                    };

                    selectButton.OnPressed += _ =>
                    {
                        // Ensure we use the most up-to-date transfer amount
                        // If user entered a new value in AmountLineEdit but didn't press Enter,
                        // try to parse it and use it
                        var amountToUse = _transferAmount;
                        if (!string.IsNullOrWhiteSpace(AmountLineEdit.Text) &&
                            int.TryParse(AmountLineEdit.Text, out var parsedAmount) &&
                            parsedAmount > 0)
                        {
                            amountToUse = parsedAmount;
                            SetAmountText(AmountLineEdit.Text, true);
                            amountToUse = _transferAmount;
                        }
                        OnSelectReagentAmount?.Invoke(reagent, amountToUse);
                    };

                    buttonsContainer.AddChild(selectButton);

                    // Remove button
                    var removeButton = new Button()
                    {
                        Text = Loc.GetString("chem-master-window-remove-button"),
                        StyleClasses = { StyleBase.ButtonSquare },
                        MinSize = new Vector2(60, 0)
                    };

                    removeButton.OnPressed += _ =>
                    {
                        // Ensure we use the most up-to-date transfer amount
                        var amountToUse = _transferAmount;
                        if (!string.IsNullOrWhiteSpace(AmountLineEdit.Text) &&
                            int.TryParse(AmountLineEdit.Text, out var parsedAmount) &&
                            parsedAmount > 0)
                        {
                            amountToUse = parsedAmount;
                            // Update _transferAmount and validate
                            SetAmountText(AmountLineEdit.Text, true);
                            amountToUse = _transferAmount; // Use the validated amount
                        }
                        OnRemoveReagentAmount?.Invoke(reagent, amountToUse);
                    };

                    buttonsContainer.AddChild(removeButton);

                    rowContainer.AddChild(buttonsContainer);
                }
                else
                {
                    // If not buffer or no reagent, add color panel here
                    rowContainer.AddChild(colorPanel);
                }

                rowContainer.AddChild(reagentButtonConstructor);
                var transferAllButton = new Button() { Text = Loc.GetString("chem-master-window-buffer-all-amount"), StyleClasses = { StyleBase.ButtonOpenLeft } };
                transferAllButton.OnPressed += _ => OnTransferAllPressed?.Invoke(reagent, isBuffer, IsOutputTab);
                rowContainer.AddChild(transferAllButton);
            }
            else
            {
                // If no reagent button constructor, add color panel at the end
                rowContainer.AddChild(colorPanel);
            }
            // ADT-Tweak End

            //Apply panencontainer to allow for striped rows
            return new PanelContainer
            {
                PanelOverride = new StyleBoxFlat(currentRowColor),
                Children = { rowContainer }
            };
        }

        public string LabelLine
        {
            get => LabelLineEdit.Text;
            set => LabelLineEdit.Text = value;
        }

        public ReagentId? SelectedReagentId => string.IsNullOrEmpty(_lastState?.SelectedReagent?.Prototype)
            ? null
            : _lastState.SelectedReagent;
    }

    public sealed class ReagentButton : Button
    {
        public bool IsBuffer = true;
        public ReagentId Id { get; set; }
        public ReagentButton(string text, ReagentId id, bool isBuffer)
        {
            AddStyleClass(StyleBase.ButtonSquare); // ADT-Tweak
            Text = text;
            Id = id;
            IsBuffer = isBuffer;
        }
    }

    // ADT-Tweak Start: Sort methods for reagents in buffer and pill buffer
    public enum ReagentSortMethod
    {
        Time,
        Alphabetical,
        Amount
    }
    // ADT-Tweak End
}
