using System.Linq;
using System.Numerics;
using Content.Client.Message;
using Content.Shared.Atmos;
using Content.Client.UserInterface.Controls;
using Content.Shared.Chemistry.Reagent; // ADT-Tweak
using Content.Shared.Alert;
using Content.Shared.Damage;
using Content.Shared.Damage.Prototypes;
using Content.Shared.FixedPoint;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.IdentityManagement;
using Content.Shared.Inventory;
using Content.Shared.MedicalScanner;
using Content.Shared.Mobs;
using Content.Shared.Mobs.Components;
using Content.Shared.Mobs.Systems;
using Content.Shared.Nutrition.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.HealthAnalyzer.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class HealthAnalyzerWindow : FancyWindow
    {
        private static readonly Color Green = Color.FromHex("#00FF00"); // ADT-Tweak
        private static readonly Color Red = Color.FromHex("#FF0000"); // ADT-Tweak

        private readonly IEntityManager _entityManager;
        private readonly SpriteSystem _spriteSystem;
        private readonly IPrototypeManager _prototypes;
        private readonly IResourceCache _cache;

        public HealthAnalyzerWindow()
        {
            RobustXamlLoader.Load(this);

            var dependencies = IoCManager.Instance!;
            _entityManager = dependencies.Resolve<IEntityManager>();
            _spriteSystem = _entityManager.System<SpriteSystem>();
            _prototypes = dependencies.Resolve<IPrototypeManager>();
            _cache = dependencies.Resolve<IResourceCache>();
        }

        public void Populate(HealthAnalyzerScannedUserMessage msg)
        {
            var target = _entityManager.GetEntity(msg.TargetEntity);

            if (target == null
                || !_entityManager.TryGetComponent<DamageableComponent>(target, out var damageable))
            {
                NoPatientDataText.Visible = true;
                return;
            }

            NoPatientDataText.Visible = false;

            // Scan Mode

            ScanModeLabel.Text = msg.ScanMode.HasValue
                ? msg.ScanMode.Value
                    ? Loc.GetString("health-analyzer-window-scan-mode-active")
                    : Loc.GetString("health-analyzer-window-scan-mode-inactive")
                : Loc.GetString("health-analyzer-window-entity-unknown-text");

            ScanModeLabel.FontColorOverride = msg.ScanMode.HasValue && msg.ScanMode.Value ? Color.Green : Color.Red;

            // Patient Information

            SpriteView.SetEntity(target.Value);
            SpriteView.Visible = msg.ScanMode.HasValue && msg.ScanMode.Value;
            NoDataTex.Visible = !SpriteView.Visible;

            var name = new FormattedMessage();
            name.PushColor(Color.White);
            name.AddText(_entityManager.HasComponent<MetaDataComponent>(target.Value)
                ? Identity.Name(target.Value, _entityManager)
                : Loc.GetString("health-analyzer-window-entity-unknown-text"));
            NameLabel.SetMessage(name);

            SpeciesLabel.Text =
                _entityManager.TryGetComponent<HumanoidAppearanceComponent>(target.Value,
                    out var humanoidAppearanceComponent)
                    ? Loc.GetString(_prototypes.Index<SpeciesPrototype>(humanoidAppearanceComponent.Species).Name)
                    : Loc.GetString("health-analyzer-window-entity-unknown-species-text");

            // Basic Diagnostic

            TemperatureLabel.Text = !float.IsNaN(msg.Temperature)
                ? $"{msg.Temperature - Atmospherics.T0C:F1} Â°C ({msg.Temperature:F1} K)"
                : Loc.GetString("health-analyzer-window-entity-unknown-value-text");

            // ADT-Tweak start: - blood level color gradient and exclaimation marks to show severity
            if (!float.IsNaN(msg.BloodLevel))
            {
                var bloodPercent = msg.BloodLevel;
                var exclamations = bloodPercent switch {
                  <= 0f => "!!!!",
                  <= 0.25f => "!!!",
                  <= 0.5f => "!!",
                  <= 0.75f => "!",
                  _ => ""
                };

                BloodLabel.Text = $"{bloodPercent * 100:F1} %{exclamations}";

                // Color gradient: Goes from green at 100% to red at 50% then stays red.
                var clampedPercent = Math.Max(bloodPercent, 0.5f);
                var scaled = (clampedPercent - 0.5f) / 0.5f;

                BloodLabel.FontColorOverride = Color.InterpolateBetween(Red, Green, scaled);
            }
            // ADT-Tweak end
            else
            {
                BloodLabel.Text = Loc.GetString("health-analyzer-window-entity-unknown-value-text");
                BloodLabel.FontColorOverride = null;
            }

            StatusLabel.Text =
                _entityManager.TryGetComponent<MobStateComponent>(target.Value, out var mobStateComponent)
                    ? GetStatus(mobStateComponent.CurrentState)
                    : Loc.GetString("health-analyzer-window-entity-unknown-text");

            // Total Damage

            DamageLabel.Text = damageable.TotalDamage.ToString();

            // Alerts

            var showAlerts = msg.Unrevivable == true || msg.Bleeding == true;

            AlertsDivider.Visible = showAlerts;
            AlertsContainer.Visible = showAlerts;

            if (showAlerts)
                AlertsContainer.DisposeAllChildren();

            if (msg.Unrevivable == true)
                AlertsContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString("health-analyzer-window-entity-unrevivable-text"),
                    Margin = new Thickness(0, 4),
                    MaxWidth = 300
                });

            if (msg.Bleeding == true)
                AlertsContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString("health-analyzer-window-entity-bleeding-text"),
                    Margin = new Thickness(0, 4),
                    MaxWidth = 300
                });

            // Damage Groups

            var damageSortedGroups =
                damageable.DamagePerGroup.OrderByDescending(damage => damage.Value)
                    .ToDictionary(x => x.Key, x => x.Value);

            IReadOnlyDictionary<string, FixedPoint2> damagePerType = damageable.Damage.DamageDict;

            DrawDiagnosticGroups(damageSortedGroups, damagePerType);

            DrawMetabolizingChemicals(msg.MetabolizingReagents); // ADT-Tweak - Metabolizing Chemicals Section
        }

        private static string GetStatus(MobState mobState)
        {
            return mobState switch
            {
                MobState.Alive => Loc.GetString("health-analyzer-window-entity-alive-text"),
                MobState.Critical => Loc.GetString("health-analyzer-window-entity-critical-text"),
                MobState.Dead => Loc.GetString("health-analyzer-window-entity-dead-text"),
                _ => Loc.GetString("health-analyzer-window-entity-unknown-text"),
            };
        }
        // ADT-Tweak start: - Draw Damage Groups in a two column grid in their own boxes.
        private void DrawDiagnosticGroups(
            Dictionary<string, FixedPoint2> groups,
            IReadOnlyDictionary<string, FixedPoint2> damageDict)
        {
            GroupsContainer.RemoveAllChildren();

            var gridContainer = new GridContainer
            {
                Columns = 2,
            };

            GroupsContainer.AddChild(gridContainer);

            var columnIndex = 0;
            foreach (var (damageGroupId, damageAmount) in groups)
            {
                var groupTitleText = $"{Loc.GetString(
                    "health-analyzer-window-damage-group-text",
                    ("damageGroup", _prototypes.Index<DamageGroupPrototype>(damageGroupId).LocalizedName),
                    ("amount", damageAmount)
                )}";

                // Create a bordered box for each damage group
                var groupBox = new PanelContainer
                {
                    Margin = new Thickness(2),
                    MinWidth = 200,
                };

                // Boxes in the second column get right aligned
                if (columnIndex % 2 == 1)
                {
                    groupBox.HorizontalAlignment = HAlignment.Right;
                }

                groupBox.PanelOverride = new StyleBoxFlat
                {
                    BorderColor = Color.Gray,
                    BorderThickness = new Thickness(1),
                    ContentMarginLeftOverride = 4,
                    ContentMarginRightOverride = 4,
                    ContentMarginTopOverride = 4,
                    ContentMarginBottomOverride = 4,
                };

                var groupContainer = new BoxContainer
                {
                    Align = BoxContainer.AlignMode.Begin,
                    Orientation = BoxContainer.LayoutOrientation.Vertical,
                };

                var titleRow = CreateDiagnosticGroupTitleRow(groupTitleText, (float)damageAmount, damageGroupId);
                groupContainer.AddChild(titleRow);

                // Add divider line under the title row
                var divider = new PanelContainer
                {
                    MinHeight = 1,
                    Margin = new Thickness(0, 0, 0, 4),
                };
                divider.PanelOverride = new StyleBoxFlat(Color.Gray);
                groupContainer.AddChild(divider);

                var group = _prototypes.Index<DamageGroupPrototype>(damageGroupId);

                foreach (var type in group.DamageTypes)
                {
                    if (!damageDict.TryGetValue(type, out var typeAmount) || typeAmount <= 0)
                        continue;

                    var damageTypeName = _prototypes.Index<DamageTypePrototype>(type).LocalizedName;
                    var typeId = type.ToString().ToLowerInvariant();

                    var damageRow = new BoxContainer
                    {
                        Orientation = BoxContainer.LayoutOrientation.Horizontal,
                        Margin = new Thickness(0, 2),
                    };

                    // Add damage type icon
                    damageRow.AddChild(new TextureRect
                    {
                        SetSize = new Vector2(15, 15),
                        Texture = GetTexture(typeId),
                        Margin = new Thickness(0, 0, 4, 0),
                    });

                    var typeLabel = new Label
                    {
                        Text = damageTypeName,
                        HorizontalExpand = true,
                        HorizontalAlignment = HAlignment.Left,
                    };

                    var amountLabel = new Label
                    {
                        Text = typeAmount.ToString(),
                        HorizontalAlignment = HAlignment.Right,
                    };

                    damageRow.AddChild(typeLabel);
                    damageRow.AddChild(amountLabel);
                    groupContainer.AddChild(damageRow);
                }

                groupBox.AddChild(groupContainer);
                gridContainer.AddChild(groupBox);
                columnIndex++;
            }
        }

        // Metabolizing chemicals display
        private void DrawMetabolizingChemicals(List<(string ReagentId, FixedPoint2 Quantity)>? reagents)
        {
            ChemicalsContainer.RemoveAllChildren();

            var hasChemicals = reagents != null && reagents.Count > 0;

            ChemicalsDivider.Visible = hasChemicals;
            ChemicalsContainer.Visible = hasChemicals;

            if (!hasChemicals || reagents == null)
                return;

            // Sort by quantity descending
            var sortedReagents = reagents.OrderByDescending(r => r.Quantity).ToList();

            foreach (var reagent in sortedReagents)
            {
                var reagentName = reagent.ReagentId;
                var reagentColor = Color.White;

                if (_prototypes.TryIndex<ReagentPrototype>(reagent.ReagentId, out var reagentProto))
                {
                    reagentName = reagentProto.LocalizedName;
                    reagentColor = reagentProto.SubstanceColor;

                }

                var rowContainer = new BoxContainer
                {
                    Orientation = BoxContainer.LayoutOrientation.Horizontal,
                    Margin = new Thickness(0, 2),
                };

                // Color bar
                var colorBar = new PanelContainer
                {
                    MinWidth = 10,
                    MinHeight = 16,
                    Margin = new Thickness(0, 0, 6, 0),
                };
                colorBar.PanelOverride = new StyleBoxFlat(reagentColor);

                var nameLabel = new Label
                {
                    Text = reagentName,
                    HorizontalExpand = true,
                    HorizontalAlignment = HAlignment.Left,
                };

                var quantityLabel = new Label
                {
                    Text = $"{reagent.Quantity}u",
                    HorizontalAlignment = HAlignment.Right,
                };

                rowContainer.AddChild(colorBar);
                rowContainer.AddChild(nameLabel);
                rowContainer.AddChild(quantityLabel);
                ChemicalsContainer.AddChild(rowContainer);
            }
        }
        // ADT-Tweak end

        private Texture GetTexture(string texture)
        {
            var rsiPath = new ResPath("/Textures/ADT/Objects/Devices/health_analyzer.rsi"); // ADT-Tweak - new rsi for new icons :)
            var rsiSprite = new SpriteSpecifier.Rsi(rsiPath, texture);

            var rsi = _cache.GetResource<RSIResource>(rsiSprite.RsiPath).RSI;
            if (!rsi.TryGetState(rsiSprite.RsiState, out var state))
            {
                rsiSprite = new SpriteSpecifier.Rsi(rsiPath, "unknown");
            }

            return _spriteSystem.Frame0(rsiSprite);
        }

        private static Label CreateDiagnosticItemLabel(string text)
        {
            return new Label
            {
                Text = text,
            };
        }

        // ADT-Tweak start: - damage group titles get a color gradient and exclamations to indicate severity
        private BoxContainer CreateDiagnosticGroupTitleRow(string text, float damageAmount, string damageGroupId)
        {
            // Color gradient: green (0) -> red (100+)
            var clampedDamage = Math.Min(damageAmount, 100f);
            var damagePercent = clampedDamage / 100f;

            var titleColor = Color.InterpolateBetween(Green, Red, damagePercent);

            var exclamations = damageAmount switch {
                > 200f => " !!!!",
                > 100f => " !!!",
                > 75f => " !!",
                > 50f => " !",
                _ => ""
            };
            var titleRow = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                Margin = new Thickness(0, 0, 0, 4),
            };

            var groupId = damageGroupId.ToLowerInvariant();

            // Add damage group icon
            titleRow.AddChild(new TextureRect
            {
                SetSize = new Vector2(15, 15),
                Texture = GetTexture(groupId),
                Margin = new Thickness(0, 0, 4, 0),
                VerticalAlignment = VAlignment.Center,
            });

            var titleLabel = new Label
            {
                Text = text + exclamations,
                HorizontalExpand = true,
                HorizontalAlignment = HAlignment.Center,
                FontColorOverride = titleColor,
            };

            titleRow.AddChild(titleLabel);

            return titleRow;
        }
        // ADT-Tweak end
    }
}
